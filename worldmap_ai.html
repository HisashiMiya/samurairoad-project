<div id="modalAI" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h2>ğŸ“¸ AIã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒ™ãƒ«</h2>
      <button class="close-btn" onclick="closeAIModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div id="apiKeySection" style="background:#f0f4ff; padding:10px; border-radius:8px; margin-bottom:15px;">
        <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Gemini API Key (ä¿å­˜ã•ã‚Œã¾ã™)</label>
        <input type="password" id="geminiApiKey" placeholder="AIzaSy..." style="width:100%; padding:8px; box-sizing:border-box; border:1px solid #ccc; border-radius:4px;">
      </div>

      <div id="aiTargetRoute" style="margin-bottom:15px; font-weight:bold; color:#0066cc;">
        ã¾ãšã¯åœ°å›³ä¸Šã§è¡—é“(é’ã„ç·š)ã‚’é¸æŠã—ã¦ãã ã•ã„
      </div>

      <div class="upload-area" style="border:2px dashed #ccc; padding:20px; text-align:center; border-radius:8px; cursor:pointer;" onclick="document.getElementById('aiFileInput').click()">
        <p>ğŸ“· å†™çœŸã‚’æ’®ã‚‹ / ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
        <input type="file" id="aiFileInput" accept="image/*" style="display:none" onchange="previewImage(this)">
        <img id="aiPreview" style="max-width:100%; max-height:200px; display:none; margin-top:10px; border-radius:4px;">
      </div>

      <button id="btnGenerateAI" onclick="runAIGeneration()" disabled style="width:100%; padding:12px; background:#ccc; color:white; border:none; border-radius:20px; font-size:16px; margin-top:15px; cursor:pointer;">
        âœ¨ ã“ã®é¢¨æ™¯ã‚’å¤‰æ›ã™ã‚‹
      </button>

      <div id="aiResultArea" style="display:none; margin-top:20px; text-align:center;">
        <h3>ç”Ÿæˆçµæœ</h3>
        <img id="aiResultImg" style="width:100%; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
        <p id="aiStory" style="font-size:14px; color:#555; margin-top:10px; font-style:italic;"></p>
      </div>
    </div>
  </div>
</div>

<button id="btnOpenAI" onclick="openAIModal()" style="
  position: absolute; bottom: 100px; right: 20px;
  width: 56px; height: 56px;
  background: linear-gradient(135deg, #6e8efb, #a777e3);
  color: white; border: none; border-radius: 50%;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  z-index: 1000; font-size: 24px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
">ğŸ“¸</button>

<script>
// ==========================================
// â–¼ AIæ©Ÿèƒ½ãƒ­ã‚¸ãƒƒã‚¯
// ==========================================

// CSVãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
let allRoutesData = [];

// èµ·å‹•æ™‚ã«CSVã‚’èª­ã¿è¾¼ã‚€
fetch('world-routes.csv')
  .then(r => r.text())
  .then(text => {
    // ç°¡æ˜“CSVãƒ‘ãƒ¼ã‚µãƒ¼
    const lines = text.split('\n');
    const headers = lines[0].split(',');
    for(let i=1; i<lines.length; i++){
      const row = lines[i].split(',');
      if(row.length < 2) continue;
      // å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã ã‘æŠ½å‡º
      allRoutesData.push({
        id: row[0], // No
        name: row[1], // åå‰
        feature: row[6], // ç‰¹å¾´
        tags: row[3], // ã‚¿ã‚°
        mood: row[9], // è¡¨æƒ…å¤‰åŒ–
        story: row[8] // ç‰©èªã‚¹ã‚¤ãƒƒãƒ
      });
    }
    console.log("AI Routes Loaded:", allRoutesData.length);
  });

// ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
function openAIModal() {
  document.getElementById('modalAI').style.display = 'flex';
  const savedKey = localStorage.getItem('gemini_api_key_v1');
  if(savedKey) document.getElementById('geminiApiKey').value = savedKey;
  
  // é¸æŠä¸­ã®è¡—é“ã‚’ç¢ºèª (AppStateã¯æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®å¤‰æ•°ã¨ä»®å®š)
  const currentId = window.AppState ? window.AppState.currentRouteId : null;
  const targetDiv = document.getElementById('aiTargetRoute');
  const btn = document.getElementById('btnGenerateAI');
  
  if(currentId) {
    const route = allRoutesData.find(r => r.id == currentId);
    if(route) {
      targetDiv.innerHTML = `é¸æŠä¸­: <b>${route.name}</b><br><span style="font-size:12px;color:#666">${route.feature}</span>`;
      targetDiv.dataset.routeId = currentId;
      checkReady();
    } else {
      targetDiv.innerHTML = "ã‚¨ãƒ©ãƒ¼: è¡—é“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
    }
  } else {
    targetDiv.innerHTML = "âš ï¸ å…ˆã«åœ°å›³ä¸Šã®ãƒ”ãƒ³ã‚’æŠ¼ã—ã¦ã€è¡—é“ã‚’é¸æŠã—ã¦ãã ã•ã„";
  }
}

function closeAIModal() {
  document.getElementById('modalAI').style.display = 'none';
}

// ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
function previewImage(input) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('aiPreview').src = e.target.result;
      document.getElementById('aiPreview').style.display = 'block';
      checkReady();
    }
    reader.readAsDataURL(input.files[0]);
  }
}

// å®Ÿè¡Œå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
function checkReady() {
  const hasFile = document.getElementById('aiFileInput').files.length > 0;
  const hasRoute = document.getElementById('aiTargetRoute').dataset.routeId;
  const btn = document.getElementById('btnGenerateAI');
  
  if(hasFile && hasRoute) {
    btn.disabled = false;
    btn.style.background = "#0066cc";
    btn.innerText = "âœ¨ ã“ã®é¢¨æ™¯ã‚’å¤‰æ›ã™ã‚‹";
  } else {
    btn.disabled = true;
    btn.style.background = "#ccc";
  }
}

// AIç”Ÿæˆå®Ÿè¡Œ (Gemini API)
async function runAIGeneration() {
  const apiKey = document.getElementById('geminiApiKey').value;
  if(!apiKey) { alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  localStorage.setItem('gemini_api_key_v1', apiKey);

  const routeId = document.getElementById('aiTargetRoute').dataset.routeId;
  const route = allRoutesData.find(r => r.id == routeId);
  const fileInput = document.getElementById('aiFileInput');
  
  // ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«
  const btn = document.getElementById('btnGenerateAI');
  btn.disabled = true;
  btn.innerText = "â³ æ™‚ç©ºã‚’ç§»å‹•ä¸­... (ç´„10-20ç§’)";

  try {
    // ç”»åƒã‚’Base64ã«å¤‰æ›
    const base64Data = await new Promise((resolve) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result.split(',')[1]);
      reader.readAsDataURL(fileInput.files[0]);
    });

    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
    const prompt = `
      Transform this street photo into a cinematic scene from "${route.name}".
      Key features to add: ${route.feature}.
      Atmosphere/Mood: ${route.mood}.
      Style: Photorealistic, high quality, historical travel photography.
      Keep the original perspective but change the materials (e.g., asphalt to stone, modern buildings to historical ones if appropriate).
    `;

    // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [
            { text: prompt },
            { inline_data: { mime_type: "image/jpeg", data: base64Data } }
          ]
        }]
      })
    });

    const data = await response.json();
    
    if(data.candidates && data.candidates[0].content) {
      // çµæœè¡¨ç¤ºã¯ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã®ãƒ¢ãƒ‡ãƒ«ã®å ´åˆã‚‚ã‚ã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ãŒã€
      // 1.5 Flashã¯ç”»åƒå…¥å‡ºåŠ›å¯¾å¿œã®ãŸã‚ã€å®Ÿéš›ã«ã¯ãƒ†ã‚­ã‚¹ãƒˆè§£èª¬ãŒè¿”ã£ã¦ãã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚
      // â˜…æ³¨æ„: ç¾åœ¨ã®ç„¡æ–™æ APIã§ã¯ã€Œç”»åƒç”Ÿæˆ(å‡ºåŠ›)ã€ã¯ç›´æ¥ã§ãã¾ã›ã‚“ã€‚
      // ãã®ãŸã‚ã€ã“ã“ã§ã¯ã€Œãƒ†ã‚­ã‚¹ãƒˆã«ã‚ˆã‚‹è©³ç´°ãªæå†™ã€ï¼‹ã€Œé›°å›²æ°—è§£èª¬ã€ã‚’è¡¨ç¤ºã™ã‚‹å½¢ã«ã—ã¾ã™ã€‚
      // â€»ç”»åƒç”Ÿæˆã‚’è¡Œã„ãŸã„å ´åˆã¯ã€Imagen APIãªã©åˆ¥ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå¿…è¦ã§ã™ãŒã€
      // ä»Šå›ã¯Geminiã§ã€Œç‰©èªã€ã‚’ç”Ÿæˆã—ã€ãã‚Œã‚’è¡¨ç¤ºã™ã‚‹ä»•æ§˜ã«ã—ã¾ã™ã€‚
      
      const aiText = data.candidates[0].content.parts[0].text;
      document.getElementById('aiResultArea').style.display = 'block';
      // ç”»åƒç”ŸæˆAPIã§ã¯ãªã„ãŸã‚ã€å…ƒã®ç”»åƒã‚’è¡¨ç¤ºã—ã¤ã¤ã€ç‰©èªã‚’è¡¨ç¤º
      document.getElementById('aiResultImg').src = document.getElementById('aiPreview').src; 
      document.getElementById('aiResultImg').style.filter = "sepia(0.6) contrast(1.2)"; // ç°¡æ˜“ãƒ•ã‚£ãƒ«ã‚¿ã§é›°å›²æ°—å‡ºã—
      document.getElementById('aiStory').innerText = "ã€AIã«ã‚ˆã‚‹é¢¨æ™¯ã®å†è§£é‡ˆã€‘\n" + aiText;
    } else {
      alert("AIã‹ã‚‰ã®å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
    }

  } catch (e) {
    alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
    console.error(e);
  } finally {
    btn.disabled = false;
    btn.innerText = "âœ¨ å†åº¦å¤‰æ›ã™ã‚‹";
  }
}
</script>