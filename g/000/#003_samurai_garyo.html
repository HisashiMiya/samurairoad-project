<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>SAMURAI DIE: GARYO</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@500;800&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap');

    :root {
        --bg: #050505;
        --paper: #eaddcf;
        --blood: #e60000;
        --gold: #d4af37;
        --font-jp: 'Shippori Mincho', serif;
        --font-en: 'Cinzel', serif;
    }

    body {
        background: var(--bg);
        color: var(--paper);
        font-family: var(--font-jp);
        margin: 0; padding: 0;
        height: 100vh; overflow: hidden;
        user-select: none;
        display: flex; flex-direction: column;
    }

    /* Scene */
    .scene {
        flex: 1; position: relative;
        perspective: 1000px;
        background: radial-gradient(circle at center, #222 0%, #000 100%);
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        overflow: hidden;
    }

    /* Enemy Card (3D Image) */
    .enemy-stage {
        width: 200px; height: 200px;
        position: relative;
        transform-style: preserve-3d;
        margin-bottom: 20px;
        transition: transform 0.1s;
    }
    .enemy-img-frame {
        width: 100%; height: 100%;
        border: 4px solid var(--gold);
        background: #000;
        box-shadow: 0 0 30px rgba(0,0,0,0.8);
        overflow: hidden;
        position: relative;
    }
    .enemy-img {
        width: 100%; height: 100%;
        object-fit: cover;
        filter: sepia(0.3) contrast(1.2);
    }
    .enemy-overlay {
        position: absolute; inset: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
    }
    .enemy-stats {
        position: absolute; bottom: 0; width: 100%;
        text-align: center; padding: 5px;
        color: #fff; font-family: var(--font-en);
        text-shadow: 0 1px 3px #000;
    }
    
    /* Type Badge */
    .type-badge {
        position: absolute; top: -10px; right: -10px;
        background: var(--blood); color: #fff;
        width: 40px; height: 40px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold; border: 2px solid #fff;
        box-shadow: 0 2px 5px #000; z-index: 5;
    }

    /* Rage Bar */
    .rage-container {
        position: absolute; bottom: -15px; left: 0; width: 100%;
        height: 8px; background: #333; border: 1px solid #555;
    }
    .rage-fill {
        height: 100%; width: 0%; background: var(--blood);
        transition: width 0.3s;
        box-shadow: 0 0 10px var(--blood);
    }

    /* Dice */
    .dice-container {
        display: flex; gap: 15px; margin-top: 40px;
        transform-style: preserve-3d;
    }
    .cube {
        width: 65px; height: 65px; position: relative;
        transform-style: preserve-3d;
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .face {
        position: absolute; width: 65px; height: 65px;
        background: #e6e2d3; border: 2px solid #8b7d6b; border-radius: 6px;
        display: flex; align-items: center; justify-content: center;
        font-size: 32px; font-weight: bold; color: #111;
        backface-visibility: hidden;
    }
    .cube.locked .face { background: #333; color: #888; border-color: var(--gold); }
    .cube.locked::after { content:"üîí"; position:absolute; top:-15px; left:25px; font-size:12px; }

    .face.front { transform: translateZ(32.5px); }
    .face.back { transform: rotateY(180deg) translateZ(32.5px); }
    .face.right { transform: rotateY(90deg) translateZ(32.5px); }
    .face.left { transform: rotateY(-90deg) translateZ(32.5px); }
    .face.top { transform: rotateX(90deg) translateZ(32.5px); }
    .face.bottom { transform: rotateX(-90deg) translateZ(32.5px); }

    /* UI Layer */
    .ui-layer {
        position: absolute; inset: 0; pointer-events: none; z-index: 10;
        display: flex; flex-direction: column; justify-content: space-between; padding: 15px;
    }
    .header { display: flex; justify-content: space-between; pointer-events: auto; }
    .status-box { background: rgba(0,0,0,0.7); padding: 5px 10px; border: 1px solid #555; border-radius: 4px; text-align: center; }
    .status-label { font-size: 10px; color: #aaa; }
    .status-val { font-size: 18px; font-weight: bold; color: var(--gold); }

    .footer { text-align: center; pointer-events: auto; padding-bottom: 20px; }
    
    .btn {
        background: rgba(0,0,0,0.8); border: 2px solid var(--paper);
        color: var(--paper); font-family: var(--font-jp);
        font-size: 18px; padding: 15px 40px; cursor: pointer;
        transition: all 0.2s; position: relative; overflow: hidden;
    }
    .btn:active { transform: scale(0.95); background: #333; }
    
    .btn-issen {
        background: var(--blood); border-color: var(--blood); color: #fff;
        display: none; box-shadow: 0 0 20px var(--blood);
        animation: pulse 1s infinite;
    }
    @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }

    .btn-upload {
        position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
        background: #222; border: 1px solid #666; color: #ccc;
        font-size: 12px; padding: 5px 15px; cursor: pointer; pointer-events: auto;
        z-index: 20; border-radius: 20px;
    }
    
    /* Settings */
    .settings-btn { font-size: 24px; background:none; border:none; color:#666; cursor:pointer; }
    .modal {
        position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100;
        display: none; align-items: center; justify-content: center; flex-direction: column;
    }

    /* Effects */
    #flash { position: fixed; inset: 0; background: #fff; opacity: 0; pointer-events: none; transition: opacity 0.1s; z-index: 50; }
    #blood-particles { position: fixed; inset: 0; pointer-events: none; z-index: 51; }

</style>
</head>
<body>

<input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFile(this)">
<button class="btn-upload" onclick="document.getElementById('file-input').click()">üì∑ ÂÜô„ÅóÁµµ (UPLOAD)</button>

<div id="flash"></div>
<canvas id="blood-particles"></canvas>

<div class="ui-layer">
    <div class="header">
        <div class="status-box">
            <div class="status-label">LVL</div>
            <div class="status-val" id="ui-lvl">1</div>
        </div>
        <div class="status-box" style="border-color:var(--blood)">
            <div class="status-label">LIFE</div>
            <div class="status-val" id="ui-hp" style="color:var(--blood)">10</div>
        </div>
        <button class="settings-btn" onclick="toggleSettings()">‚öô</button>
    </div>

    <div class="footer">
        <button class="btn btn-issen" id="btn-issen" onclick="actIssen()">‰∏ÄÈñÉ (SLASH)</button>
        <button class="btn btn-roll" id="btn-roll" onclick="actRoll()">
            Ê∞óÂêà (REROLL)<br><span style="font-size:10px; opacity:0.7">-1 HP / +RAGE</span>
        </button>
    </div>
</div>

<div class="scene">
    <div class="enemy-stage" id="enemy-stage">
        <div class="type-badge" id="enemy-type">?</div>
        <div class="enemy-img-frame">
            <img id="enemy-img" class="enemy-img" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjMzMzIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiAvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNTU1IiBmb250LXNpemU9IjIwIj5OTyBJTUFHRTwvdGV4dD48L3N2Zz4=">
            <div class="enemy-overlay"></div>
            <div class="enemy-stats">
                <div id="enemy-name" style="font-size:18px; font-weight:bold;">SHADOW</div>
                <div id="enemy-req" style="font-size:12px; color:var(--gold);">REQ: PAIR</div>
            </div>
        </div>
        <div class="rage-container"><div class="rage-fill" id="ui-rage"></div></div>
    </div>

    <div class="dice-container" id="dice-container">
        </div>
</div>

<div id="settings-modal" class="modal">
    <h2 style="color:var(--gold)">SETTINGS</h2>
    <div style="margin:20px; display:flex; gap:10px;">
        <button class="btn" onclick="setLang('ja')">Êó•Êú¨Ë™û</button>
        <button class="btn" onclick="setLang('en')">ENGLISH</button>
    </div>
    <div style="margin:20px;">
        <button class="btn" id="snd-btn" onclick="toggleSound()">SOUND: ON</button>
    </div>
    <button class="btn" style="border-color:#666" onclick="toggleSettings()">CLOSE</button>
</div>

<script>
    // --- Config & State ---
    const KANJI = ["","Â£±","Âºê","ÂèÇ","Âõõ","‰ºç","ÂÖ≠"];
    let cfg = { lang: 'ja', sound: true };
    let state = {
        lvl: 1, hp: 10, maxHp: 10,
        dice: [1,2,3], locks: [false, false, false],
        enemy: { name: "SHADOW", req: 'pair', rage: 0, rageRate: 20, type: 'N' }
    };

    // --- Audio (Web Audio API) ---
    const actx = new (window.AudioContext || window.webkitAudioContext)();
    function playSnd(key) {
        if(!cfg.sound) return;
        if(actx.state==='suspended') actx.resume();
        const t = actx.currentTime;
        const o = actx.createOscillator();
        const g = actx.createGain();
        o.connect(g); g.connect(actx.destination);

        if(key==='roll') {
            for(let i=0;i<3;i++){
                let n=actx.createOscillator(); let ng=actx.createGain();
                n.connect(ng); ng.connect(actx.destination);
                n.frequency.value=100+Math.random()*200; n.type='square';
                ng.gain.setValueAtTime(0.05,t); ng.gain.linearRampToValueAtTime(0,t+0.1);
                n.start(t); n.stop(t+0.1);
            }
        }
        if(key==='slash') {
            // Noise
            let b=actx.createBuffer(1,actx.sampleRate*0.2,actx.sampleRate);
            let d=b.getChannelData(0); for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;
            let s=actx.createBufferSource(); s.buffer=b;
            let f=actx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=3000;
            s.connect(f); f.connect(g); g.connect(actx.destination);
            g.gain.setValueAtTime(0.5,t); g.gain.linearRampToValueAtTime(0,t+0.2);
            s.start(t);
        }
        if(key==='dmg') {
            o.type='sawtooth'; o.frequency.setValueAtTime(100,t); o.frequency.exponentialRampToValueAtTime(10,t+0.3);
            g.gain.setValueAtTime(0.5,t); g.gain.linearRampToValueAtTime(0,t+0.3);
            o.start(t); o.stop(t+0.3);
        }
    }

    // --- Image Analysis & Enemy Generation ---
    function handleFile(input) {
        const file = input.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                analyzeAndSpawn(img);
                document.getElementById('enemy-img').src = e.target.result;
            }
        };
        reader.readAsDataURL(file);
    }

    function analyzeAndSpawn(img) {
        // Draw to hidden canvas to read pixels
        const c = document.createElement('canvas');
        const ctx = c.getContext('2d');
        c.width = 100; c.height = 100; // Resize for speed
        ctx.drawImage(img, 0, 0, 100, 100);
        
        const data = ctx.getImageData(0, 0, 100, 100).data;
        let r=0, g=0, b=0, bright=0;
        
        for(let i=0; i<data.length; i+=4) {
            r += data[i]; g += data[i+1]; b += data[i+2];
            bright += (data[i]+data[i+1]+data[i+2])/3;
        }

        // Determine Type
        let type = "N"; // Normal
        let name = "SPIRIT";
        let rageRate = 20;
        let req = "pair"; // pair or str

        if(r > g*1.2 && r > b*1.2) { type="ÁÅ´"; name="BLAZE ONI"; rageRate=30; } // Aggressive
        else if(b > r*1.2 && b > g*1.2) { type="Ê∞∑"; name="FROST YUKAI"; rageRate=15; req="str"; } // Technical
        else if(g > r*1.2 && g > b*1.2) { type="È¢®"; name="WIND TENGU"; rageRate=25; }
        else if(bright/data.length < 50) { type="Èóá"; name="SHADOW"; rageRate=40; req="pair"; } // Hard
        else { type="ÂÖâ"; name="HOLY BEAST"; rageRate=10; req="str"; }

        // Setup Enemy
        state.enemy = {
            name: name,
            type: type,
            req: req,
            rage: 0,
            rageRate: rageRate
        };

        // Visual Updates
        document.getElementById('enemy-name').innerText = name;
        document.getElementById('enemy-type').innerText = type;
        document.getElementById('enemy-req').innerText = req === 'pair' ? "REQ: PAIR („Çæ„É≠ÁõÆ)" : "REQ: STRAIGHT (ÈÄ£Áï™)";
        
        // Reset Dice
        state.locks = [false,false,false];
        rollInternal();
        updateUI();

        // Animation
        const stage = document.getElementById('enemy-stage');
        stage.style.transform = "scale(0.1)";
        setTimeout(() => stage.style.transform = "scale(1)", 200);
    }

    // --- Dice 3D ---
    function initDice() {
        const c = document.getElementById('dice-container');
        c.innerHTML = '';
        for(let i=0; i<3; i++){
            let d = document.createElement('div'); d.className='cube';
            d.onclick = ()=>toggleLock(i);
            for(let f=0; f<6; f++){
                let face=document.createElement('div');
                face.className = `face ${['front','back','right','left','top','bottom'][f]}`;
                d.appendChild(face);
            }
            c.appendChild(d);
        }
        updateDice();
    }

    function updateDice() {
        const cubes = document.querySelectorAll('.cube');
        cubes.forEach((c, i) => {
            const v = state.dice[i];
            const locked = state.locks[i];
            
            // Text
            c.querySelectorAll('.face').forEach((f,fi)=> f.innerText = cfg.lang=='ja'?KANJI[fi+1]:(fi+1));

            // Rotate
            const rots = [[0,0],[0,0],[0,180],[0,-90],[0,90],[-90,0],[90,0]];
            const r = rots[v];
            c.style.transform = `rotateX(${r[0]}deg) rotateY(${r[1]}deg)`;
            if(locked) c.classList.add('locked'); else c.classList.remove('locked');
        });
    }

    function toggleLock(i) {
        state.locks[i] = !state.locks[i];
        updateDice();
    }

    // --- Game Logic ---
    function actRoll() {
        if(state.hp <= 1) return; // No suicide
        state.hp--;
        state.enemy.rage += state.enemy.rageRate;
        playSnd('roll');

        // Spin anim
        document.querySelectorAll('.cube').forEach((c,i)=>{
            if(!state.locks[i]) c.style.transform += ` rotateX(360deg) rotateY(360deg)`;
        });

        setTimeout(()=>{
            rollInternal();
            if(state.enemy.rage >= 100) enemyAttack();
            updateUI();
        }, 400);
        updateUI();
    }

    function rollInternal() {
        state.dice = state.dice.map((v,i)=> state.locks[i]?v : Math.ceil(Math.random()*6));
        updateDice();
        checkWin();
    }

    function checkWin() {
        const d = state.dice;
        const counts = {}; d.forEach(x=>counts[x]=(counts[x]||0)+1);
        let win = false;
        
        if(state.enemy.req === 'pair') win = Object.values(counts).some(c=>c>=2);
        if(state.enemy.req === 'str') { const s=[...d].sort().join(''); win=(s==='123'||s==='456'); }

        const bi = document.getElementById('btn-issen');
        const br = document.getElementById('btn-roll');
        if(win) { bi.style.display='block'; br.style.display='none'; }
        else { bi.style.display='none'; br.style.display='block'; }
    }

    function enemyAttack() {
        playSnd('dmg');
        state.hp = Math.max(0, state.hp - 3);
        state.enemy.rage = 0;
        
        // Shake
        const st = document.getElementById('enemy-stage');
        st.style.transform = "translate(5px, 5px)";
        setTimeout(()=>st.style.transform="none", 100);

        // Flash Red
        const el = document.getElementById('flash');
        el.style.backgroundColor = 'red'; el.style.opacity = 0.3;
        setTimeout(()=>el.style.opacity=0, 200);

        if(state.hp <= 0) alert("GAME OVER");
    }

    function actIssen() {
        playSnd('slash');
        // Flash White
        const el = document.getElementById('flash');
        el.style.backgroundColor = 'white'; el.style.opacity = 0.8;
        setTimeout(()=>el.style.opacity=0, 100);

        state.hp = Math.min(state.maxHp, state.hp+2);
        state.lvl++;
        
        // Next Enemy (Reset image for loop)
        state.enemy.rage = 0;
        state.enemy.req = Math.random()>0.5 ? 'str' : 'pair';
        state.locks = [false,false,false];
        rollInternal();
        updateUI();
    }

    // --- UI & Settings ---
    function updateUI() {
        document.getElementById('ui-lvl').innerText = state.lvl;
        document.getElementById('ui-hp').innerText = state.hp;
        document.getElementById('ui-rage').style.width = state.enemy.rage + "%";
    }

    function toggleSettings() {
        const m = document.getElementById('settings-modal');
        m.style.display = m.style.display==='flex'?'none':'flex';
    }
    function setLang(l) { cfg.lang = l; initDice(); updateUI(); }
    function toggleSound() { 
        cfg.sound = !cfg.sound; 
        document.getElementById('snd-btn').innerText = cfg.sound ? "SOUND: ON" : "SOUND: OFF";
    }

    // Start
    initDice();
    updateUI();

</script>
</body>
</html>