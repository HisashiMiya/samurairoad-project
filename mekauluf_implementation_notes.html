<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="page_title">Project Mech-Wolf | Implementation Notes（取り組み）</title>
  <meta name="description" content="Project Mech-Wolfの実装メモ。監査ログ（runs）、L2経験のバージョン管理、厳格なJSON出力と自己修復、ステージ遷移の安全化など。">
  <meta property="og:type" content="article">
  <meta property="og:title" content="Project Mech-Wolf | Implementation Notes（取り組み）">
  <meta property="og:description" content="監査ログ・L2バージョン管理・JSON自己修復・安全なルーティング。">
  <style>
    :root{--bg:#0b0f14;--panel:#121924;--text:#e7eef8;--muted:#a8b3c2;--line:#223044;--accent:#63f6d7;--accent2:#8aa5ff;}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;background:var(--bg);color:var(--text);line-height:1.75;}

    /* ✅ Mech-Wolf top nav */
    .mw-nav{position:sticky;top:0;z-index:50;background:rgba(11,15,20,.92);backdrop-filter:blur(8px);border-bottom:1px solid rgba(34,48,68,.9);}
    .mw-nav .inner{max-width:980px;margin:0 auto;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .mw-brand{display:flex;gap:10px;align-items:baseline;text-decoration:none;color:var(--text);}
    .mw-brand b{letter-spacing:.06em}
    .mw-brand span{color:var(--accent2);font-size:12px}
    .mw-links{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .mw-links a,.mw-links button{border:1px solid rgba(34,48,68,.9);background:transparent;color:var(--text);padding:6px 10px;border-radius:10px;font-size:13px;cursor:pointer;text-decoration:none;}
    .mw-links a:hover,.mw-links button:hover{border-color:rgba(138,165,255,.8)}
    .mw-links .primary{border-color:rgba(99,246,215,.9)}

    .container{max-width:980px;margin:0 auto;padding:34px 20px 70px;}
    .card{background:linear-gradient(180deg, rgba(18,25,36,.92), rgba(15,22,32,.92));border:1px solid rgba(34,48,68,.9);border-radius:18px;padding:22px;margin:14px 0;}
    h1{margin:0 0 8px;font-size:30px;letter-spacing:.02em}
    h2{margin:0 0 10px;font-size:20px;border-left:4px solid var(--accent2);padding-left:12px}
    h3{margin:18px 0 8px;font-size:16px}
    .muted{color:var(--muted)}
    code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Noto Sans Mono",monospace;background:rgba(0,0,0,.25);border:1px solid rgba(34,48,68,.8);border-radius:12px;}
    pre{padding:14px;overflow:auto}
    a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
    .hr{height:1px;background:rgba(34,48,68,.8);margin:14px 0}
    .pill{display:inline-block;padding:2px 10px;border:1px solid rgba(138,165,255,.4);border-radius:999px;font-size:12px;color:var(--muted);margin-right:6px}
  </style>
</head>
<body>

<div class="mw-nav">
  <div class="inner">
    <a class="mw-brand" href="./mekauluf_strategy.html" aria-label="Project Mech-Wolf">
      <b>Mech-Wolf</b>
      <span data-i18n="nav_tag">Implementation</span>
    </a>
    <div class="mw-links">
      <a href="./index.html" data-i18n="nav_home">SamuraiRoad Home</a>
      <a href="./mekauluf_strategy.html" data-i18n="nav_strategy">Strategy</a>
      <a href="./mekauluf_implementation_exp.html" data-i18n="nav_extension">Engine Extension</a>
      <a class="primary" href="./mekauluf_implementation_notes.html" data-i18n="nav_notes">Implementation Notes</a>
<button id="mwLangBtn" type="button" class="mw-lang" aria-label="Language switch">
  <span class="mw-langHint" data-i18n="lang_hint">Language</span>
  <span id="mwLangLabel" class="mw-langValue">日本語</span>
</button>
    </div>
  </div>
</div>

  <div class="container">
    <div class="card">
      <h1 data-i18n="h1">Implementation Notes（取り組み）</h1>
      <p class="muted" data-i18n="lead">
        ここは「計画（思想）」ではなく「実装（挙動）」のページ。<br>
        主文書（メカウルフ計画）からは、議論を呼ぶフックを保ちつつ、実装の具体をこちらに隔離する。
      </p>
      <p class="muted">
        Source: <code>universal_agent_engine.py</code>
      </p>
    </div>

    <!-- ===== 以下、本文は原文を維持 ===== -->

    <div class="card">
      <h2>1. 監査ログ（runs）と再現性</h2>
      <p>
        実行ごとに <span class="pill">Run ID</span> を採番し、<code>runs/&lt;run_id&gt;</code> に監査ログを保存する。
        これにより「そのとき何が起きたか」を後から検証できる。
      </p>
      <pre><code>run_id = datetime.now().strftime("%Y%m%d-%H%M%S")
run_dir = os.path.join(DIRS["runs"], run_id)</code></pre>
    </div>

    <div class="card">
      <h2>2. 経験（L2）のバージョン管理</h2>
      <p>
        経験は上書きせず、<code>core_experience_v*.md</code> として世代管理する。<br>
        “進化”はいつでもロールバック可能であるべき、という設計意図。
      </p>
      <pre><code>files = glob.glob(os.path.join(DIRS["workspace"], "core_experience_v*.md"))
latest_file = max(files, key=os.path.getctime)</code></pre>
    </div>

    <div class="card">
      <h2>3. JSON強制と自己修復（Self-Healing）</h2>
      <p>
        LLM出力は厳格JSONに強制。パース失敗時はエラーをフィードバックして修復リトライする。<br>
        「構造的揺らぎ」を許さず、「修復ポイント」として扱う。
      </p>
      <pre><code>parsed_json = json.loads(raw_text)

except json.JSONDecodeError as e:
  current_prompt = f"...有効なJSONではありません...エラー詳細: {e}"</code></pre>
    </div>

    <div class="card">
      <h2>4. 目的（Purpose）を憲法として固定</h2>
      <p>
        Purposeは外部ファイル（<code>order/purpose.txt</code>）から読み込み、プロンプト中で「遵守必須」として提示する。
        目的をコードに埋め込まないのは、監査と差し替えを容易にするため。
      </p>
      <pre><code>purpose_path = os.path.join(DIRS["order"], "purpose.txt")
state["purpose"] = open(purpose_path, "r", encoding="utf-8").read().strip()</code></pre>
    </div>

    <div class="card">
      <h2>5. ルーティングの安全化（ディレクトリトラバーサル対策）</h2>
      <p>
        ステージ遷移は自由度が高いほど危険。許可ディレクトリ配下のファイルのみを実行することで、
        逸脱経路を最小化する。
      </p>
      <pre><code>stage_path = os.path.abspath(os.path.join(DIRS["stages"], current_stage))
if not stage_path.startswith(DIRS["stages"]) or not os.path.exists(stage_path):
  break</code></pre>
    </div>

    <div class="card">
      <h2>6. Librarian：経験の昇華（ノイズ排除）</h2>
      <p>
        タスク完了後にLibrarianが起動し、L1ログと既存L2を比較して、
        ノイズや失敗の正当化を排除しつつ教訓を抽出する。
      </p>
      <pre><code>{
  "deleted_rules": "...",
  "added_rules": "...",
  "new_l2_markdown": "最新の経験ルール5箇条..."
}</code></pre>
      <div class="hr"></div>
      <p class="muted">
        重要：現状コード内にもコメントがある通り、理想形では完了前にVerifier（検証官）のPASSを挟む余地がある。
      </p>
    </div>

    <div class="card">
      <h2>7. 「人間の差分」を縮める方向性</h2>
      <p>
        この実装は、AIが「経験を糧にする」側（ログ→教訓→L2）を強化している。<br>
        次に「経験を取りに行く」側（探索・観測・外部収集）と、「意味を決める」側（評価関数・代理報酬）を実装すると、
        人間との差分（経験の流入と価値決定の制御点）をさらに縮められる。
      </p>
    </div>

    <div class="card">
      <p class="muted">
        ← 主文書に戻る：<a href="./mekauluf_strategy.html" data-i18n="back_strategy">メカウルフ計画（戦略版）</a>
      </p>
    </div>
  </div>

<div data-include="./includes/footer.html" aria-label="Footer"></div>
<script src="./assets/js/sr-common.js" defer></script>

<script>
(function(){
  const KEY = "sr_lang"; // SamuraiRoad global language state
  const dict = {
    en: {
      lang_hint: "Language",
      page_title: "Project Mech-Wolf | Implementation Notes",
      nav_tag: "Implementation",
      nav_home: "SamuraiRoad Home",
      nav_strategy: "Strategy",
      nav_extension: "Engine Extension",
      nav_notes: "Implementation Notes",
      h1: "Implementation Notes",
      lead: "This page focuses on implementation behavior (not philosophy). It isolates concrete mechanisms: runs/audit logs, L2 versioning, strict JSON output + self-healing, safe stage routing, and librarian summarization.",
      back_strategy: "Back to Strategy",
    },
    ja: {
    
      lang_hint: "言語",
      page_title: "Project Mech-Wolf | Implementation Notes（取り組み）",
      nav_tag: "Implementation",
      nav_home: "SamuraiRoad Home",
      nav_strategy: "戦略（計画）",
      nav_extension: "拡張ノート",
      nav_notes: "実装ノート",
      h1: "Implementation Notes（取り組み）",
      lead: "ここは「計画（思想）」ではなく「実装（挙動）」のページ。<br>主文書からは、議論を呼ぶフックを保ちつつ、実装の具体をこちらに隔離する。",
      back_strategy: "メカウルフ計画（戦略版）",
    }
  };

  function apply(lang){
    const t = dict[lang] || dict.ja;
    document.documentElement.lang = lang;
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const k = el.getAttribute("data-i18n");
      if (t[k] != null) el.innerHTML = t[k];
    });
    const btn = document.getElementById("mwLangLabel");
    if (btn) btn.textContent = (lang === "ja" ? "EN" : "JP");
    localStorage.setItem(KEY, lang);
  }

  const initial = localStorage.getItem(KEY) || "ja";
  apply(initial);

  const btn = document.getElementById("mwLangBtn");
  if (btn){
    btn.addEventListener("click", ()=>{
      const cur = localStorage.getItem(KEY) || "ja";
      apply(cur === "ja" ? "en" : "ja");
    });
  }
})();
</script>
</body>
</html>