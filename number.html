<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Number Duel</title>
  <style>
    body{font-family:system-ui, sans-serif; padding:16px;}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    input,button{font-size:16px; padding:8px;}
    #log{white-space:pre-wrap; background:#f6f6f6; padding:12px; border-radius:8px; margin-top:12px;}
    .small{opacity:.7; font-size:12px;}
  </style>
</head>
<body>
  <h1>æ•°å­—ã‚²ãƒ¼ãƒ ï¼ˆWebSocketï¼‰</h1>

  <div class="row">
    <label>room <input id="room" value="tX" /></label>
    <label>name <input id="name" value="hisa" /></label>
    <button id="btnConnect">Connect</button>
    <button id="btnDisconnect" disabled>Disconnect</button>
  </div>

  <div class="row" style="margin-top:10px;">
    <label>number <input id="num" type="number" min="0" max="999" value="7" /></label>
    <button id="btnSubmit" disabled>Submit</button>
    <button id="btnReveal" disabled>Reveal</button>
    <button id="btnReset" disabled>Reset</button>
  </div>

  <div class="small" id="status">disconnected</div>
  <div class="small" id="presence"></div>

  <div id="log"></div>

<script>
let ws = null;

const $ = (id)=>document.getElementById(id);
const log = (s)=>{ $("log").textContent = (s + "\n" + $("log").textContent).slice(0, 5000); };

function setConnected(on){
  $("btnConnect").disabled = on;
  $("btnDisconnect").disabled = !on;
  $("btnSubmit").disabled = !on;
  $("btnReveal").disabled = !on;
  $("btnReset").disabled = !on;
  $("status").textContent = on ? "connected" : "disconnected";
}

$("btnConnect").onclick = () => {
  const room = encodeURIComponent($("room").value.trim() || "lobby");
  const name = encodeURIComponent($("name").value.trim() || "guest");
  const wsUrl = `${location.origin.replace(/^http/, "ws")}/ws?room=${room}&name=${name}`;

  ws = new WebSocket(wsUrl);

  ws.onopen = ()=>{ setConnected(true); log("WS open"); };
  ws.onclose = ()=>{ setConnected(false); log("WS close"); ws=null; };
  ws.onerror = ()=>{ log("WS error"); };
  ws.onmessage = (ev)=>{
    const msg = JSON.parse(ev.data);
    if (msg.type === "presence") {
      $("presence").textContent = `players: ${msg.players.join(", ")} / submissions: ${msg.submissionsCount}`;
    }
    if (msg.type === "reveal") {
      if (msg.winner) {
        log(`ðŸ† WINNER: ${msg.winner.name} = ${msg.winner.value} (${msg.mode})`);
      } else {
        log(`ðŸ™… winnerãªã— (${msg.mode})`);
      }
      log("entries: " + msg.entries.map(e=>`${e.name}:${e.value}`).join(", "));
    } else {
      log(JSON.stringify(msg));
    }
  };
};

$("btnDisconnect").onclick = () => {
  if (ws) ws.close();
};

$("btnSubmit").onclick = () => {
  const v = Number($("num").value);
  ws?.send(JSON.stringify({type:"submit", value:v}));
};

$("btnReveal").onclick = () => {
  ws?.send(JSON.stringify({type:"reveal"}));
};

$("btnReset").onclick = () => {
  ws?.send(JSON.stringify({type:"reset"}));
};
</script>
</body>
</html>
