<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Global Kaido Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* --- Styles --- */
    :root { --primary: #0066cc; --danger: #cc0000; --bg: #ffffff; --text: #333333; --accent: #ff9800; }
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; height: 100vh; width: 100vw; color: var(--text); background: var(--bg); }
    
    body { padding-bottom: 80px; box-sizing: border-box; }

    #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    
    /* Top Bar */
    .top-bar {
      position: absolute; top: 10px; left: 68px; right: 10px; z-index: 1000;
      background: rgba(255,255,255,0.95); backdrop-filter: blur(4px);
      padding: 10px 14px; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex; flex-direction: column; gap: 4px; pointer-events: none;
    }
    .top-bar * { pointer-events: auto; }
    .status-title { font-weight: 800; font-size: 16px; color: var(--primary); pointer-events: auto; }
    .status-info { font-size: 12px; color: #666; pointer-events: auto; }

    /* Bottom Bar */
    .bottom-bar {
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000;
      display: flex; gap: 12px;
      background: rgba(255,255,255,0.95); backdrop-filter: blur(4px);
      padding: 10px 16px; border-radius: 50px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .action-btn {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: none; border: none; cursor: pointer; color: #555; gap: 2px; min-width: 55px;
    }
    .action-btn svg { width: 24px; height: 24px; fill: currentColor; }
    .action-btn span { font-size: 10px; font-weight: bold; }
    .action-btn:active { transform: scale(0.95); }

    /* FABs (Floating Action Buttons) */
    .fab-container {
      position: absolute; bottom: 100px; right: 20px; z-index: 1000;
      display: flex; flex-direction: column; gap: 15px; align-items: center;
    }
    .fab-btn {
      width: 50px; height: 50px; border-radius: 50%;
      background: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      font-size: 24px; cursor: pointer; color: #333; display: flex; align-items: center; justify-content: center;
      transition: transform 0.1s;
    }
    .fab-btn:active { transform: scale(0.95); }
    /* æ­´å²ã‚¬ã‚¤ãƒ‰ãƒœã‚¿ãƒ³ç”¨ã®ç‰¹åˆ¥è‰² */
    #btnHistory { background: var(--primary); color: white; font-size: 22px; }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 2000;
      display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px);
    }
    .modal-overlay.open { display: flex; }
    .modal-content {
      background: white; width: 90%; max-width: 400px; max-height: 80vh;
      border-radius: 16px; padding: 20px; overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    h2 { margin: 0 0 15px; font-size: 18px; border-bottom: 2px solid #eee; padding-bottom: 8px; }
    .list-group { display: flex; flex-direction: column; gap: 8px; }
    .list-item {
      padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee;
      cursor: pointer; font-weight: 600; display: flex; justify-content: space-between; align-items: center;
    }
    .list-item:hover { background: #eef4ff; border-color: var(--primary); color: var(--primary); }
    
    /* Samurai Item Special Style */
    .item-samurai { border-color: #ffd700; background: #fffbe6; color: #856404; }

    .btn-block { width: 100%; padding: 12px; margin-top: 10px; background: #333; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; }
    .btn-danger { background: var(--danger); }
    .btn-secondary { background: #555; }
    
    /* Settings Row */
    .settings-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 14px; font-weight: bold; }
    
    /* Toast */
    .toast {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.85); color: white; padding: 15px 25px;
      border-radius: 30px; font-size: 14px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 3000;
      max-width: 80%; text-align: center; white-space: pre-wrap; line-height: 1.5;
    }
    .toast.show { opacity: 1; }
    
    /* Hamburger */
    .hamburger {
      position: absolute; top: 14px; left: 14px; z-index: 1100;
      width: 44px; height: 44px; border: none; border-radius: 12px;
      background: rgba(255,255,255,0.95); box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex; align-items: center; justify-content: center; cursor: pointer;
    }
    .hamburger .bars { width: 18px; height: 12px; display: grid; gap: 3px; }
    .hamburger .bars span { display: block; height: 2px; background: #333; border-radius: 2px; }
  </style>
</head>
<body>

  <div id="map"></div>

  <button class="hamburger" id="btnHamburger" aria-label="menu">
    <div class="bars"><span></span><span></span><span></span></div>
  </button>

  <div class="modal-overlay" id="modalMainMenu">
    <div class="modal-content">
      <h2>Menu</h2>
      <div class="list-group">
        <div class="list-item" id="menuItemRoutes">ğŸ—ºï¸ <span data-lang="menu_routes">æ¢ã™</span></div>
        <div class="list-item" id="menuItemRecord">âºï¸ <span data-lang="menu_record">è¨˜éŒ²</span></div>
        
        <div class="list-item item-samurai" id="menuItemSamurai">
          ğŸ“· <span data-lang="menu_samurai">ä¾ã®ç›®ã§è¦‹ã‚‹</span>
        </div>
        <input type="file" id="inpSamuraiCamera" accept="image/*" capture="environment" style="display:none;">

        <div class="list-item" id="menuItemReport">ğŸ“ <span data-lang="menu_report">å ±å‘Š</span></div>
        <div class="list-item" id="menuItemSettings">âš™ï¸ <span data-lang="menu_settings">è¨­å®š</span></div>
      </div>
      <button class="btn-block" style="background:#888;" onclick="closeModals()" data-lang="btn_close">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div class="top-bar">
    <div class="status-title" id="lblCurrentRoute">--</div>
    <div class="status-info" id="lblNavInfo">--</div>
  </div>

  <div class="fab-container">
    <button class="fab-btn" id="btnHistory" title="What is this place?">ğŸ“</button>
    <button class="fab-btn" id="btnLocate" title="Current Location">â—</button>
  </div>

  <div class="bottom-bar">
    <button class="action-btn" id="btnMenuRoutes">
      <svg viewBox="0 0 24 24"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
      <span data-lang="menu_routes">æ¢ã™</span>
    </button>
    <button class="action-btn" id="btnMenuRecord">
      <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
      <span id="lblRecordBtn" data-lang="menu_record">è¨˜éŒ²</span>
    </button>
    <button class="action-btn" id="btnMenuReport">
      <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 12h-2v-2h2v2zm0-4h-2V6h2v4z"/></svg>
      <span data-lang="menu_report">å ±å‘Š</span>
    </button>
    <button class="action-btn" id="btnMenuSettings">
      <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.488.488 0 0 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32a.49.49 0 0 0-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
      <span data-lang="menu_settings">è¨­å®š</span>
    </button>
  </div>

  <div class="modal-overlay" id="modalRoutes">
    <div class="modal-content">
      <h2 data-lang="title_select">è¡—é“ã‚’é¸æŠ</h2>
      <div id="routeListContainer" class="list-group"></div>
      <button class="btn-block" style="background:#888;" onclick="closeModals()" data-lang="btn_close">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div class="modal-overlay" id="modalRecord">
    <div class="modal-content">
      <h2 data-lang="title_record">è¨˜éŒ² (GPSãƒ­ã‚°)</h2>
      <div id="recordStats" style="margin-bottom:15px; font-size:14px; line-height:1.6;">
        <span data-lang="lbl_status">çŠ¶æ…‹</span>: <span id="valRecStatus" style="font-weight:bold;">--</span><br>
        <span data-lang="lbl_points">ç‚¹æ•°</span>: <span id="valRecPoints">0</span>
      </div>
      <button class="btn-block" id="btnStartStopRecord" style="background:var(--primary);" data-lang="btn_start">è¨˜éŒ²é–‹å§‹</button>
      
      <div style="margin-top:16px; border-top:1px solid #eee; padding-top:10px;">
        <input type="file" id="inpGpxFile" accept=".gpx" style="display:none;">
        <button class="btn-block btn-secondary" onclick="document.getElementById('inpGpxFile').click()" data-lang="btn_import">GPXèª­è¾¼</button>
      </div>

      <button class="btn-block btn-secondary" id="btnDownloadGpx" style="margin-top:10px;" data-lang="btn_gpx">GPXãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button class="btn-block btn-danger" id="btnClearRecord" style="margin-top:10px;" data-lang="btn_clear">ã‚¯ãƒªã‚¢</button>
      <button class="btn-block" style="background:#888; margin-top:20px;" onclick="closeModals()" data-lang="btn_close">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div class="modal-overlay" id="modalSettings">
      <div class="modal-content">
        <h2 data-lang="title_settings">è¨­å®š</h2>
        
        <div class="settings-row">
          <span data-lang="lbl_lang">è¨€èª / Language</span>
          <button id="btnToggleLang" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc; background:#eee; cursor:pointer;">æ—¥æœ¬èª</button>
        </div>

        <div class="settings-row">
          <span data-lang="lbl_wakelock">ç”»é¢å¸¸æ™‚ç‚¹ç¯</span>
          <input type="checkbox" id="chkWakeLock" style="transform:scale(1.5);">
        </div>
        
        <button class="btn-block btn-secondary" style="margin-top:15px; background:#0088cc;" onclick="window.open('usage.html', '_blank')">
          ğŸ“– <span data-lang="btn_usage">ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</span>
        </button>
        <button class="btn-block" style="background:#888; margin-top:20px;" onclick="closeModals()" data-lang="btn_close">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  
  <div class="toast" id="toast"></div>

<div id="loadingModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:10000; align-items:center; justify-content:center; flex-direction:column;">
    <div style="border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 1.5s linear infinite;"></div>
    <p id="loadingText" style="margin-top:20px; font-weight:bold; color:#333; font-size:18px;">ä¾ãŒè€ƒãˆä¸­...</p>
</div>

<style>
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<div id="aiModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:white; color:#333; padding:20px; border-radius:12px; width:90%; height:80%; display:flex; flex-direction:column; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
        
        <div id="aiContent" style="overflow-y:auto; flex-grow:1; font-size:16px; line-height:1.8; white-space: pre-wrap; margin-bottom:15px; padding:10px;"></div>
        
        <button onclick="document.getElementById('aiModal').style.display='none'" style="padding:15px; background:#0066cc; color:white; border:none; border-radius:8px; font-weight:bold; font-size:16px; cursor:pointer;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script src="./assets/js/config.js?v=20260118" defer></script>
<script>
(() => {
  // =========================================
  // 0. è¾æ›¸ãƒ‡ãƒ¼ã‚¿ (Dictionary)
  // =========================================
  const DICT = {
    ja: {
      menu_routes: "æ¢ã™", menu_record: "è¨˜éŒ²", menu_report: "å ±å‘Š", menu_settings: "è¨­å®š",
      menu_samurai: "ä¾ã®ç›®ã§è¦‹ã‚‹", 
      title_select: "è¡—é“ã‚’é¸æŠ", btn_close: "é–‰ã˜ã‚‹",
      title_record: "è¨˜éŒ² / GPX", lbl_status: "çŠ¶æ…‹", lbl_points: "ç‚¹æ•°",
      btn_start: "è¨˜éŒ²é–‹å§‹", btn_stop: "è¨˜éŒ²åœæ­¢", btn_gpx: "ä¿å­˜(DL)", btn_clear: "ã‚¯ãƒªã‚¢", btn_import: "GPXèª­è¾¼",
      title_settings: "è¨­å®š", lbl_lang: "è¨€èª / Language", lbl_wakelock: "ç”»é¢å¸¸æ™‚ç‚¹ç¯",
      btn_usage: "ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰",
      status_recording: "è¨˜éŒ²ä¸­...", status_stopped: "åœæ­¢ä¸­",
      msg_start: "è¨˜éŒ²ã‚’é–‹å§‹ã—ã¾ã—ãŸ", msg_stop: "è¨˜éŒ²ã‚’åœæ­¢ã—ã¾ã—ãŸ", msg_clear: "ãƒ­ã‚°ã‚’æ¶ˆå»ã—ã¾ã—ãŸ",
      msg_no_data: "ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“", msg_loaded: "èª­ã¿è¾¼ã¿å®Œäº†", msg_error: "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ",
      route_no_select: "è¡—é“æœªé¸æŠ", nav_info_init: "ã€Œæ¢ã™ã€ã‹ã‚‰è¡—é“ã‚’é¸ã‚“ã§ãã ã•ã„",
      route_loading: "èª­è¾¼ä¸­...", region_jp: "æ—¥æœ¬ (äº”è¡—é“ãƒ»å·¡ç¤¼)", region_world: "æµ·å¤– / ãã®ä»–",
      msg_ai_analyzing: "ğŸ¤– è§£æä¸­...\nã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„",
      msg_ai_history_search: "ğŸ“ æ­´å²ã‚’èª¿æŸ»ä¸­...\n(ç¾åœ¨åœ°å‘¨è¾º)",
      ai_samurai_prefix: "ã€ä¾ã®ç›®ã€‘\n",
      err_occurred: "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ",
      samurai_thinking: "ä¾ãŒè€ƒãˆä¸­..."
    },
    en: {
      menu_routes: "Routes", menu_record: "Record", menu_report: "Report", menu_settings: "Config",
      menu_samurai: "Samurai Vision",
      title_select: "Select Route", btn_close: "Close",
      title_record: "GPS & GPX", lbl_status: "Status", lbl_points: "Points",
      btn_start: "Start", btn_stop: "Stop", btn_gpx: "Download", btn_clear: "Clear", btn_import: "Import GPX",
      title_settings: "Settings", lbl_lang: "Language", lbl_wakelock: "Keep Screen On",
      btn_usage: "How to Use",
      status_recording: "Recording...", status_stopped: "Stopped",
      msg_start: "Recording started", msg_stop: "Recording stopped", msg_clear: "Log cleared",
      msg_no_data: "No data found", msg_loaded: "Route loaded", msg_error: "Error occurred",
      route_no_select: "No Route", nav_info_init: "Select a route from menu",
      route_loading: "Loading...", region_jp: "Japan", region_world: "World / Other",
      msg_ai_analyzing: "ğŸ¤– Analyzing...",
      msg_ai_history_search: "ğŸ“ Searching History...",
      ai_samurai_prefix: "[Samurai Vision]\n",
      err_occurred: "Error occurred",
      samurai_thinking: "The Samurai is thinking..."
    }
  };

  // =========================================
  // 1. ãƒ‡ãƒ¼ã‚¿å®šç¾©
  // =========================================
  const WORLD_ROUTES = [
    { 
      region_ja: "æ—¥æœ¬ ", region_en: "Japan", 
      routes: [
        { id: "tokaido", name_ja: "æ±æµ·é“", name_en: "Tokaido", file: "data/tokaido_strict.geojson" },
        { id: "nakasendo", name_ja: "ä¸­å±±é“", name_en: "Nakasendo", file: "data/nakaendo_route.geojson" },
        { id: "koshu", name_ja: "ç”²å·è¡—é“", name_en: "Koshu Kaido", file: "data/koshu_route.geojson" },
        { id: "nikko", name_ja: "æ—¥å…‰è¡—é“", name_en: "Nikko Kaido", file: "data/nikko_route.geojson" },
        { id: "oshu", name_ja: "å¥¥å·è¡—é“", name_en: "Oshu Kaido", file: "data/oshu_route.geojson" },
        { id: "kumano", name_ja: "ç†Šé‡å¤é“ï¼ˆä¸­è¾ºè·¯ï¼‰", name_en: "Kumano Kodo", file: "data/kumano.geojson" },
        { id: "shikoku88", name_ja: "å››å›½éè·¯ï¼ˆ88ãƒ¶æ‰€ï¼‰", name_en: "Shikoku Pilgrimage", file: "data/88tmples.geojson" },
        { id: "okunohosomichi", name_ja: "å¥¥ã®ç´°é“", name_en: "Oku no Hosomichi", file: "data/okunohosomichi.geojson" }
      ]
    },
    { 
      region_ja: "ã‚¢ã‚¸ã‚¢ / ãƒ¦ãƒ¼ãƒ©ã‚·ã‚¢", region_en: "Asia / Eurasia", 
      routes: [
        { id: "silkroad_uz", name_ja: "ã‚·ãƒ«ã‚¯ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¦ã‚ºãƒ™ã‚­ã‚¹ã‚¿ãƒ³ï¼‰", name_en: "Silk Road (Uzbekistan)", file: "data/silkroad_uz.geojson" },
        { id: "lycian", name_ja: "ãƒªã‚­ã‚¢ãƒ³ãƒ»ã‚¦ã‚§ã‚¤", name_en: "Lycian Way", file: "data/lycianway.geojson" },
        { id: "jeju", name_ja: "æ¸ˆå·ã‚ªãƒ«ãƒ¬", name_en: "Jeju Olle Trail", file: "data/jot.geojson" },
        { id: "teahorse", name_ja: "èŒ¶é¦¬å¤é“", name_en: "Tea Horse Road", file: "data/teahorseroad.geojson" },
        { id: "jesustrail", name_ja: "ã‚¸ãƒ¼ã‚¶ã‚¹ãƒ»ãƒˆãƒ¬ã‚¤ãƒ«", name_en: "Jesus Trail", file: "data/jesustrail.geojson" },
        { id: "jordantrail", name_ja: "ãƒ¨ãƒ«ãƒ€ãƒ³ãƒ»ãƒˆãƒ¬ã‚¤ãƒ«", name_en: "Jordan Trail", file: "data/jordantrail.geojson" }
      ]
    },
    { 
      region_ja: "ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘", region_en: "Europe", 
      routes: [
        { id: "appia", name_ja: "ã‚¢ãƒƒãƒ”ã‚¢è¡—é“", name_en: "Appian Way", file: "data/appia.geojson" },
        { id: "tmb", name_ja: "ãƒ„ãƒ¼ãƒ«ãƒ»ãƒ‰ãƒ»ãƒ¢ãƒ³ãƒ–ãƒ©ãƒ³", name_en: "Tour du Mont Blanc", file: "data/tmb.geojson" },
        { id: "camino", name_ja: "ã‚µãƒ³ãƒ†ã‚£ã‚¢ã‚´å·¡ç¤¼ï¼ˆãƒ•ãƒ©ãƒ³ã‚¹äººã®é“ï¼‰", name_en: "Camino de Santiago (FrancÃ©s)", file: "data/camino_frances.geojson" },
        { id: "francigena", name_ja: "ãƒ•ãƒ©ãƒ³ãƒã‚¸ã‚§ãƒŠè¡—é“", name_en: "Via Francigena", file: "data/viafrancigena.geojson" },
        { id: "whw", name_ja: "ã‚¦ã‚§ã‚¹ãƒˆãƒ»ãƒã‚¤ãƒ©ãƒ³ãƒ‰ãƒ»ã‚¦ã‚§ã‚¤", name_en: "West Highland Way", file: "data/whway.geojson" },
        { id: "hadrian", name_ja: "ãƒãƒ‰ãƒªã‚¢ãƒŒã‚¹ã®é•·åŸãƒ‘ã‚¹", name_en: "Hadrian's Wall Path", file: "data/hwp.geojson" },
        { id: "stolav", name_ja: "è–ã‚ªãƒ©ãƒ•ã®é“", name_en: "St. Olav's Way", file: "data/sow.geojson" },
        { id: "romanticroad", name_ja: "ãƒ­ãƒãƒ³ãƒãƒƒã‚¯è¡—é“", name_en: "Romantic Road", file: "data/romanticroad.geojson" },
        { id: "viaalpina", name_ja: "ãƒ´ã‚£ã‚¢ãƒ»ã‚¢ãƒ«ãƒ”ãƒŠ", name_en: "Via Alpina", file: "data/viaalpina.geojson" },
        { id: "cotswold", name_ja: "ã‚³ãƒƒãƒ„ã‚¦ã‚©ãƒ«ã‚ºãƒ»ã‚¦ã‚§ã‚¤", name_en: "Cotswold Way", file: "data/cotswoldway.geojson" },
        { id: "kungsleden", name_ja: "ã‚¯ãƒ³ã‚°ã‚¹ãƒ¬ãƒ¼ãƒ‡ãƒ³", name_en: "Kungsleden", file: "data/kungsleden.geojson" }
      ]
    },
    { 
      region_ja: "ã‚¢ãƒ¡ãƒªã‚«å¤§é™¸", region_en: "Americas", 
      routes: [
        { id: "appalachian", name_ja: "ã‚¢ãƒ‘ãƒ©ãƒã‚¢ãƒ³ãƒ»ãƒˆãƒ¬ã‚¤ãƒ«", name_en: "Appalachian Trail", file: "data/appalachian.geojson" },
        { id: "route66", name_ja: "ãƒ«ãƒ¼ãƒˆ66", name_en: "Route 66", file: "data/route66.geojson" },
        { id: "inca", name_ja: "ã‚¤ãƒ³ã‚«é“", name_en: "Inca Trail", file: "data/inca.geojson" },
        { id: "pct", name_ja: "ãƒ‘ã‚·ãƒ•ã‚£ãƒƒã‚¯ãƒ»ã‚¯ãƒ¬ã‚¹ãƒˆãƒ»ãƒˆãƒ¬ã‚¤ãƒ« (PCT)", name_en: "Pacific Crest Trail", file: "data/pct.geojson" },
        { id: "jmt", name_ja: "ã‚¸ãƒ§ãƒ³ãƒ»ãƒŸãƒ¥ãƒ¼ã‚¢ãƒ»ãƒˆãƒ¬ã‚¤ãƒ« (JMT)", name_en: "John Muir Trail", file: "data/jmt.geojson" },
        { id: "qhapaqnan", name_ja: "ã‚«ãƒ‘ãƒƒã‚¯ãƒ»ãƒ‹ãƒ£ãƒ³ï¼ˆã‚¢ãƒ³ãƒ‡ã‚¹ãƒ»ãƒ­ãƒ¼ãƒ‰ï¼‰", name_en: "Qhapaq Nan", file: "data/qhapaqnan.geojson" }
      ]
    },
    {
      region_ja: "ã‚ªã‚»ã‚¢ãƒ‹ã‚¢", region_en: "Oceania",
      routes: [
        { id: "milford", name_ja: "ãƒŸãƒ«ãƒ•ã‚©ãƒ¼ãƒ‰ãƒ»ãƒˆãƒ©ãƒƒã‚¯", name_en: "Milford Track", file: "data/milfordtrack.geojson" },
        { id: "greatocean", name_ja: "ã‚°ãƒ¬ãƒ¼ãƒˆãƒ»ã‚ªãƒ¼ã‚·ãƒ£ãƒ³ãƒ»ã‚¦ã‚©ãƒ¼ã‚¯", name_en: "Great Ocean Walk", file: "data/greatoceanwalk.geojson" }
      ]
    }
  ];

  // =========================================
  // 1.5 URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ & åˆæœŸè¨­å®š
  // =========================================
  const urlParams = new URLSearchParams(window.location.search);
  const paramLang = urlParams.get('lang');
  if (paramLang && (paramLang === 'ja' || paramLang === 'en')) {
    localStorage.setItem('kaido_lang', paramLang);
  }
  const paramRoute = urlParams.get('route');
  let initialRouteId = null;
  if (paramRoute) {
    let found = false;
    for (const group of WORLD_ROUTES) {
      if (group.routes.some(r => r.id === paramRoute)) {
        found = true;
        break;
      }
    }
    if (found) {
      initialRouteId = paramRoute;
      localStorage.setItem('kaido_active_route', initialRouteId);
    }
  }

  // =========================================
  // 2. ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹ç®¡ç† (AppState)
  // =========================================
  const AppState = {
    lang: localStorage.getItem('kaido_lang') || 'ja',
    currentRouteId: initialRouteId || localStorage.getItem('kaido_active_route') || null,
    trackPoints: JSON.parse(localStorage.getItem('kaido_track_points') || '[]'),
    isRecording: false,
    watchId: null,
    currentPos: null,
    layers: {}
  };

  const map = L.map('map', { zoomControl: false }).setView([35.681, 139.767], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  map.on("moveend", () => {
    if (!AppState.isLoadingRoute) {
      const c = map.getCenter();
      localStorage.setItem("sr_lat", String(c.lat));
      localStorage.setItem("sr_lng", String(c.lng));
      localStorage.setItem("sr_zoom", String(map.getZoom()));
    }
  });

  function restoreMapPosition() {
    if (initialRouteId) return;
    const lat = parseFloat(localStorage.getItem("sr_lat"));
    const lng = parseFloat(localStorage.getItem("sr_lng"));
    const zoom = parseFloat(localStorage.getItem("sr_zoom"));
    if (isFinite(lat) && isFinite(lng) && isFinite(zoom)){
      map.setView([lat,lng], zoom, { animate:false });
    }
  }

  // =========================================
  // 3. UI & ç¿»è¨³ & ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
  // =========================================
  
  function t(key) { return DICT[AppState.lang][key] || key; }

  function updateLanguage() {
    document.querySelectorAll('[data-lang]').forEach(el => {
      el.textContent = t(el.dataset.lang);
    });
    renderRouteMenu();
    updateRecordStats();
    renderRecordButtonState();
    updateTopBarText();
    document.getElementById('btnToggleLang').textContent = (AppState.lang === 'ja') ? "æ—¥æœ¬èª" : "English";
  }

  function toggleLanguage() {
    AppState.lang = (AppState.lang === 'ja') ? 'en' : 'ja';
    localStorage.setItem('kaido_lang', AppState.lang);
    updateLanguage();
  }

  function updateTopBarText() {
    if (!AppState.currentRouteId) {
      document.getElementById('lblCurrentRoute').textContent = t('route_no_select');
      document.getElementById('lblNavInfo').textContent = t('nav_info_init');
      return;
    }
    let name = "Unknown";
    for (const group of WORLD_ROUTES) {
      const found = group.routes.find(r => r.id === AppState.currentRouteId);
      if (found) { name = (AppState.lang === 'ja') ? found.name_ja : found.name_en; break; }
    }
    document.getElementById('lblCurrentRoute').textContent = name;
  }

  // â– â– â–  ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã®åˆ¶å¾¡ â– â– â– 
  function showLoading() {
    const modal = document.getElementById('loadingModal');
    const text = document.getElementById('loadingText');
    text.textContent = t('samurai_thinking'); // è¨€èªã«åˆã‚ã›ã¦å¤‰æ›´
    modal.style.display = "flex";
  }

  function hideLoading() {
    document.getElementById('loadingModal').style.display = "none";
  }

  // â– â– â–  AIçµæœè¡¨ç¤ºç”¨ã®è‡ªä½œã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ â– â– â– 
  function showAIResult(text) {
     const modal = document.getElementById('aiModal');
     const content = document.getElementById('aiContent');
     content.textContent = text;
     modal.style.display = "flex"; 
  }

  // =========================================
  // 4. åœ°å›³ãƒ»ãƒ«ãƒ¼ãƒˆãƒ»AIå‡¦ç†
  // =========================================

  function drawTrack() {
    if (AppState.layers.trackLine) AppState.layers.trackLine.remove();
    if (AppState.trackPoints.length < 1) return;
    const latlngs = AppState.trackPoints.map(p => [p.lat, p.lng]);
    AppState.layers.trackLine = L.polyline(latlngs, { color: 'blue', weight: 4, opacity: 0.8 }).addTo(map);
  }

  function loadActiveRoute() {
    if (!AppState.currentRouteId) { updateTopBarText(); return; }

    let targetRoute = null;
    for (const group of WORLD_ROUTES) {
      const found = group.routes.find(r => r.id === AppState.currentRouteId);
      if (found) { targetRoute = found; break; }
    }
    if (!targetRoute) return;

    updateTopBarText();
    document.getElementById('lblNavInfo').textContent = t('route_loading');
    if (AppState.layers.route) AppState.layers.route.remove();
    AppState.isLoadingRoute = true;

    fetch(targetRoute.file)
      .then(res => {
        if (!res.ok) throw new Error("File not found");
        return res.json();
      })
      .then(geoJson => {
        AppState.layers.route = L.geoJSON(geoJson, {
          style: { color: '#cc0000', weight: 5, opacity: 0.7 }
        }).addTo(map);
        map.fitBounds(AppState.layers.route.getBounds(), { padding: [50, 50] });
        document.getElementById('lblNavInfo').textContent = t('msg_loaded');
        setTimeout(() => { AppState.isLoadingRoute = false; }, 1000);
      })
      .catch(err => {
        console.error(err);
        document.getElementById('lblNavInfo').textContent = "Error";
        showToast(t('msg_error'));
        AppState.isLoadingRoute = false;
      });
  }

  // --- Gemini API å‘¼ã³å‡ºã— ---
  async function callGemini(prompt, image = null) {
    const base = (window.AI_HTTP || location.origin).replace(/\/$/, "");
    const endpoint = `${base}/ai/samuraimap`;
    const payload = { prompt };
    if (image) payload.image = image;

    try {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      return json.text || json.candidates?.[0]?.content?.parts?.[0]?.text || JSON.stringify(json);
    } catch (e) {
      throw new Error(e.message);
    }
  }

  // --- ä¾ã®ç›® (ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†) ---
  function handleSamuraiImageSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      showLoading(); // èª­ã¿è¾¼ã¿é–‹å§‹ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º

      reader.onload = function(e) {
          // Base64ã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— (data:image/jpeg;base64,... ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å‰Šé™¤)
          const base64 = e.target.result.split(',')[1];
          // AIå‡¦ç†ã¸
          processSamuraiImage(base64);
      };
      reader.readAsDataURL(file);
      
      // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€£ç¶šã§é¸ã¹ã‚‹ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆ
      event.target.value = '';
  }

  async function processSamuraiImage(base64) {
    let prompt = "";
    
    // è¨€èªè¨­å®š (AppState.lang) ã‚’æ­£ã—ãå‚ç…§
    if (AppState.lang === 'en') {
        prompt = `Where is this location?
Based on the image, please explain the scenery and its historical context (especially related to old Japanese roads if possible).
Please answer in English.
[Constraint]: Do not include titles. Start directly with the content.`;
    } else {
        prompt = `ã“ã“ã¾ã§ã®ä¼šè©±ã¯å¿˜ã‚Œã¦ãã ã•ã„ã€‚
ã“ã®ç”»åƒã¯ã©ã“ã§ã™ã‹ï¼Ÿ
è¡—é“æ­©ãã®æ—…ã®é€”ä¸­ã§æ’®å½±ã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚
ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Œã‚‹é¢¨æ™¯ã‚„ã€æ­´å²çš„ãªæ–‡è„ˆï¼ˆå®¿å ´ç”ºã‚„å²è·¡ãªã©ï¼‰ã«ã¤ã„ã¦è©³ã—ãè§£èª¬ã—ã¦ãã ã•ã„ã€‚
ã€åˆ¶ç´„äº‹é …ã€‘ã‚¿ã‚¤ãƒˆãƒ«ä¸è¦ã€‚ã„ããªã‚Šæœ¬æ–‡ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„ã€‚`;
    }

    try {
        const answer = await callGemini(prompt, base64);
        hideLoading();
        showAIResult(answer);
    } catch (e) {
        hideLoading();
        console.error(e);
        alert(t('msg_error'));
    }
  }
  
  // --- æ­´å²ã‚¬ã‚¤ãƒ‰ (GPS) ---
  async function askHistoryByGPS(latitude, longitude) {
    showLoading();
    let prompt = "";

    // è¨€èªè¨­å®š (AppState.lang) ã‚’æ­£ã—ãå‚ç…§
    if (AppState.lang === 'en') {
        prompt = `I am currently at Latitude ${latitude}, Longitude ${longitude}.
Please act as a historical guide.
Explain the history of this location (or the nearest historical road/post town) specifically focusing on the Edo period.
Please answer in English.
[Constraint]: Do not include any titles or headings. Start directly with the explanation.`;
    } else {
        prompt = `ç§ã¯ä»Šã€ç·¯åº¦${latitude}ã€çµŒåº¦${longitude}ã®å ´æ‰€ã«ã„ã¾ã™ã€‚
ã“ã®å ´æ‰€ï¼ˆã¾ãŸã¯ä¸€ç•ªè¿‘ã„æ­´å²çš„ãªè¡—é“ã‚„å®¿å ´ç”ºï¼‰ã«ã¤ã„ã¦ã€
ã€Œæ˜”ã®æ—…äººã«ãªã£ãŸæ°—åˆ†ã€ã§æ¥½ã—ã‚ã‚‹ã‚ˆã†ãªæ­´å²çš„ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚„ã€æ±Ÿæˆ¸æ™‚ä»£ã«ä½•ãŒã‚ã£ãŸã‹ã‚’è©³ã—ãæ•™ãˆã¦ãã ã•ã„ã€‚
ã€åˆ¶ç´„äº‹é …ã€‘
ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ã‚„è¦‹å‡ºã—ã¯ä¸€åˆ‡æ›¸ã‹ãªã„ã§ãã ã•ã„ã€‚
ãƒ»æŒ¨æ‹¶ã‚‚ä¸è¦ã§ã™ã€‚ã„ããªã‚Šæœ¬æ–‡ã‹ã‚‰æ›¸ãå§‹ã‚ã¦ãã ã•ã„ã€‚`;
    }

    try {
        const answer = await callGemini(prompt);
        hideLoading();
        showAIResult(answer);
    } catch (e) {
        hideLoading();
        console.error(e);
        alert(t('msg_error'));
    }
  }

  // =========================================
  // 5. è¨˜éŒ²ãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
  // =========================================
  function updateRecordStats() {
    const pts = AppState.trackPoints;
    document.getElementById('valRecStatus').textContent = AppState.isRecording ? t('status_recording') : t('status_stopped');
    document.getElementById('valRecStatus').style.color = AppState.isRecording ? "#cc0000" : "#333";
    document.getElementById('valRecPoints').textContent = pts.length;
    const btnText = document.getElementById('lblRecordBtn');
    btnText.textContent = AppState.isRecording ? "STOP" : t('menu_record');
    btnText.style.color = AppState.isRecording ? "#cc0000" : "";
  }
  function renderRecordButtonState(){
    const btn = document.getElementById('btnStartStopRecord');
    btn.textContent = AppState.isRecording ? t('btn_stop') : t('btn_start');
    btn.className = AppState.isRecording ? "btn-block btn-danger" : "btn-block";
  }
  function toggleRecord() {
    AppState.isRecording = !AppState.isRecording;
    if (AppState.isRecording) {
      if (!navigator.geolocation) { alert("GPS Not Supported"); AppState.isRecording=false; return; }
      AppState.watchId = navigator.geolocation.watchPosition(
        pos => {
          const p = { lat: pos.coords.latitude, lng: pos.coords.longitude, t: Date.now() };
          AppState.trackPoints.push(p);
          localStorage.setItem('kaido_track_points', JSON.stringify(AppState.trackPoints));
          updateRecordStats();
          drawTrack();
        },
        err => { console.error(err); },
        { enableHighAccuracy: true }
      );
      showToast(t('msg_start'));
    } else {
      if (AppState.watchId) navigator.geolocation.clearWatch(AppState.watchId);
      showToast(t('msg_stop'));
    }
    updateRecordStats();
    renderRecordButtonState();
  }
  function clearRecord() {
    if(!confirm("Clear log?")) return;
    AppState.trackPoints = [];
    localStorage.setItem('kaido_track_points', '[]');
    if(AppState.layers.trackLine) AppState.layers.trackLine.remove();
    updateRecordStats();
    showToast(t('msg_clear'));
  }
  function downloadGpx() {
    const pts = AppState.trackPoints;
    if (pts.length === 0) { alert(t('msg_no_data')); return; }
    const now = new Date();
    const defaultName = `track_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
    let fileName = prompt("File Name", defaultName);
    if (fileName === null) return;
    if (!fileName.trim()) fileName = defaultName;
    if (!fileName.toLowerCase().endsWith('.gpx')) fileName += '.gpx';
    let gpx = `<?xml version="1.0"?><gpx version="1.1"><trk><trkseg>`;
    pts.forEach(p => {
      gpx += `<trkpt lat="${p.lat}" lon="${p.lng}"><time>${new Date(p.t).toISOString()}</time></trkpt>`;
    });
    gpx += `</trkseg></trk></gpx>`;
    const blob = new Blob([gpx], {type: "application/gpx+xml"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = fileName;
    document.body.appendChild(a); a.click(); a.remove();
  }
  function importGpx(event) {
    const file = event.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(text, "text/xml");
      const trkpts = xmlDoc.getElementsByTagName("trkpt");
      AppState.trackPoints = []; 
      for (let i = 0; i < trkpts.length; i++) {
        const lat = parseFloat(trkpts[i].getAttribute("lat"));
        const lon = parseFloat(trkpts[i].getAttribute("lon"));
        const timeTag = trkpts[i].getElementsByTagName("time")[0];
        const time = timeTag ? new Date(timeTag.textContent).getTime() : Date.now();
        AppState.trackPoints.push({ lat: lat, lng: lon, t: time });
      }
      localStorage.setItem('kaido_track_points', JSON.stringify(AppState.trackPoints));
      drawTrack();
      updateRecordStats();
      if(AppState.trackPoints.length > 0) map.fitBounds(AppState.layers.trackLine.getBounds());
      showToast(t('msg_loaded'));
      closeModals();
    };
    reader.readAsText(file);
  }

  function openReportForm() {
    const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSctfcD7qgXA3t7X1bWQnXiqyTSCdh2iy1uuM07otO4xGGoU_g/viewform";
    const ID_LAT   = "entry.1725964949";
    const ID_LNG   = "entry.1039750529";
    const ID_ROUTE = "entry.2062767095";
    let params = [];
    if (AppState.currentPos) {
      params.push(`${ID_LAT}=${AppState.currentPos.lat}`);
      params.push(`${ID_LNG}=${AppState.currentPos.lng}`);
    }
    if (AppState.currentRouteId) {
      let name = AppState.currentRouteId;
      for (const group of WORLD_ROUTES) {
        const found = group.routes.find(r => r.id === AppState.currentRouteId);
        if(found) name = found.name_ja;
      }
      params.push(`${ID_ROUTE}=${encodeURIComponent(name)}`);
    }
    window.open(`${formUrl}?${params.join('&')}`, "_blank"); 
  }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  }
  window.closeModals = function() {
    document.querySelectorAll('.modal-overlay').forEach(e => e.classList.remove('open'));
  };
  function openModal(id) {
    closeModals();
    document.getElementById(id).classList.add('open');
  }
  function renderRouteMenu() {
    const container = document.getElementById('routeListContainer');
    container.innerHTML = "";
    WORLD_ROUTES.forEach(group => {
      const h3 = document.createElement('div');
      h3.style.cssText = "font-size:12px; color:#666; margin-top:10px; margin-bottom:4px; font-weight:bold;";
      h3.textContent = (AppState.lang === 'ja') ? group.region_ja : group.region_en;
      container.appendChild(h3);
      group.routes.forEach(route => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.textContent = (AppState.lang === 'ja') ? route.name_ja : route.name_en;
        div.onclick = () => {
          AppState.currentRouteId = route.id;
          localStorage.setItem('kaido_active_route', route.id);
          loadActiveRoute();
          closeModals();
          showToast(div.textContent + " Selected");
        };
        container.appendChild(div);
      });
    });
  }

  // =========================================
  // 6. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
  // =========================================
  document.getElementById('btnMenuRoutes').onclick = () => openModal('modalRoutes');
  document.getElementById('btnMenuRecord').onclick = () => openModal('modalRecord');
  document.getElementById('btnMenuSettings').onclick = () => openModal('modalSettings');
  document.getElementById('btnMenuReport').onclick = openReportForm;
  document.getElementById('btnStartStopRecord').onclick = () => toggleRecord();
  document.getElementById('btnClearRecord').onclick = clearRecord;
  document.getElementById('btnDownloadGpx').onclick = downloadGpx;
  document.getElementById('btnToggleLang').onclick = toggleLanguage;
  document.getElementById('inpGpxFile').addEventListener('change', importGpx);
  
  document.getElementById('btnHamburger').onclick = () => openModal('modalMainMenu');
  document.getElementById('menuItemRoutes').onclick = () => { closeModals(); openModal('modalRoutes'); };
  document.getElementById('menuItemRecord').onclick = () => { closeModals(); openModal('modalRecord'); };
  document.getElementById('menuItemReport').onclick = () => { closeModals(); openReportForm(); };
  document.getElementById('menuItemSettings').onclick = () => { closeModals(); openModal('modalSettings'); };

  // â˜… ä¾ã®ç›® (ç”»åƒ) ã‚¤ãƒ™ãƒ³ãƒˆä¿®æ­£ â˜…
  document.getElementById('menuItemSamurai').onclick = () => {
    closeModals();
    document.getElementById('inpSamuraiCamera').click();
  };
  // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã‚‰ handleSamuraiImageSelect ã‚’å‘¼ã¶
  document.getElementById('inpSamuraiCamera').onchange = handleSamuraiImageSelect;

  // â˜… æ­´å²ã‚¬ã‚¤ãƒ‰ (GPS) ã‚¤ãƒ™ãƒ³ãƒˆ â˜…
  document.getElementById('btnHistory').onclick = () => {
      if(!navigator.geolocation) return;
      // showLoading(); // askHistoryByGPSå†…ã§è¡Œã†ã®ã§ã“ã“ã§ã¯ä¸è¦
      navigator.geolocation.getCurrentPosition(pos => {
          askHistoryByGPS(pos.coords.latitude, pos.coords.longitude);
      }, err => alert("GPS Error: " + err.message));
  };

  // ç¾åœ¨åœ°ç§»å‹•
  document.getElementById('btnLocate').onclick = () => {
    if(!navigator.geolocation) return;
    showToast(t('route_loading'));
    navigator.geolocation.getCurrentPosition(pos => {
      const {latitude, longitude} = pos.coords;
      AppState.currentPos = { lat: latitude, lng: longitude };
      map.setView([latitude, longitude], 15);
      if(AppState.layers.me) AppState.layers.me.remove();
      AppState.layers.me = L.circleMarker([latitude, longitude], { radius:8, color:'white', fillColor:'#0066cc', fillOpacity:1 }).addTo(map);
    }, err => alert("GPS Error: " + err.message));
  };

  // åˆæœŸåŒ–å®Ÿè¡Œ
  restoreMapPosition();
  updateLanguage();
  if (AppState.currentRouteId) loadActiveRoute();
  drawTrack();

})();
</script>
</body>
</html>