<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Global Kaido Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* --- Styles --- */
    :root { --primary: #0066cc; --danger: #cc0000; --bg: #ffffff; --text: #333333; --accent: #ff9800; }
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; height: 100vh; width: 100vw; color: var(--text); background: var(--bg); }
    
    body { padding-bottom: 80px; box-sizing: border-box; }

    #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    
    /* Top Bar */
    .top-bar {
      position: absolute; top: 10px; left: 68px; right: 10px; z-index: 1000;
      background: rgba(255,255,255,0.95); backdrop-filter: blur(4px);
      padding: 10px 14px; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex; flex-direction: column; gap: 4px; pointer-events: none;
    }
    .top-bar * { pointer-events: auto; }
    .status-title { font-weight: 800; font-size: 16px; color: var(--primary); pointer-events: auto; }
    .status-info { font-size: 12px; color: #666; pointer-events: auto; }

    /* Bottom Bar */
    .bottom-bar {
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000;
      display: flex; gap: 12px;
      background: rgba(255,255,255,0.95); backdrop-filter: blur(4px);
      padding: 10px 16px; border-radius: 50px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .action-btn {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: none; border: none; cursor: pointer; color: #555; gap: 2px; min-width: 55px;
    }
    .action-btn svg { width: 24px; height: 24px; fill: currentColor; }
    .action-btn span { font-size: 10px; font-weight: bold; }
    .action-btn:active { transform: scale(0.95); }

    /* FABs (Floating Action Buttons) */
    .fab-container {
      position: absolute; bottom: 100px; right: 20px; z-index: 1000;
      display: flex; flex-direction: column; gap: 15px; align-items: center;
    }
    .fab-btn {
      width: 50px; height: 50px; border-radius: 50%;
      background: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      font-size: 24px; cursor: pointer; color: #333; display: flex; align-items: center; justify-content: center;
      transition: transform 0.1s;
    }
    .fab-btn:active { transform: scale(0.95); }
    /* Ê≠¥Âè≤„Ç¨„Ç§„Éâ„Éú„Çø„É≥Áî®„ÅÆÁâπÂà•Ëâ≤ */
    #btnHistory { background: var(--primary); color: white; font-size: 22px; }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 2000;
      display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px);
    }
    .modal-overlay.open { display: flex; }
    .modal-content {
      background: white; width: 90%; max-width: 400px; max-height: 80vh;
      border-radius: 16px; padding: 20px; overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    h2 { margin: 0 0 15px; font-size: 18px; border-bottom: 2px solid #eee; padding-bottom: 8px; }
    .list-group { display: flex; flex-direction: column; gap: 8px; }
    .list-item {
      padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee;
      cursor: pointer; font-weight: 600; display: flex; justify-content: space-between; align-items: center;
    }
    .list-item:hover { background: #eef4ff; border-color: var(--primary); color: var(--primary); }
    
    /* Samurai Item Special Style */
    .item-samurai { border-color: #ffd700; background: #fffbe6; color: #856404; }

    .btn-block { width: 100%; padding: 12px; margin-top: 10px; background: #333; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; }
    .btn-danger { background: var(--danger); }
    .btn-secondary { background: #555; }
    
    /* Settings Row */
    .settings-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 14px; font-weight: bold; }
    
    /* Toast */
    .toast {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.85); color: white; padding: 15px 25px;
      border-radius: 30px; font-size: 14px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 3000;
      max-width: 80%; text-align: center; white-space: pre-wrap; line-height: 1.5;
    }
    .toast.show { opacity: 1; }
    
    /* Hamburger */
    .hamburger {
      position: absolute; top: 14px; left: 14px; z-index: 1100;
      width: 44px; height: 44px; border: none; border-radius: 12px;
      background: rgba(255,255,255,0.95); box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex; align-items: center; justify-content: center; cursor: pointer;
    }
    .hamburger .bars { width: 18px; height: 12px; display: grid; gap: 3px; }
    .hamburger .bars span { display: block; height: 2px; background: #333; border-radius: 2px; }
  </style>
</head>
<body>

  <div id="map"></div>

  <button class="hamburger" id="btnHamburger" aria-label="menu">
    <div class="bars"><span></span><span></span><span></span></div>
  </button>

  <div class="modal-overlay" id="modalMainMenu">
    <div class="modal-content">
      <h2>Menu</h2>
      <div class="list-group">
        <div class="list-item" id="menuItemRoutes">üó∫Ô∏è <span data-lang="menu_routes">Êé¢„Åô</span></div>
        <div class="list-item" id="menuItemRecord">‚è∫Ô∏è <span data-lang="menu_record">Ë®òÈå≤</span></div>
        
        <div class="list-item item-samurai" id="menuItemSamurai">
          üì∑ <span data-lang="menu_samurai">‰æç„ÅÆÁõÆ„ÅßË¶ã„Çã</span>
        </div>
        <input type="file" id="inpSamuraiCamera" accept="image/*" capture="environment" style="display:none;">

        <div class="list-item" id="menuItemReport">üìù <span data-lang="menu_report">Â†±Âëä</span></div>
        <div class="list-item" id="menuItemSettings">‚öôÔ∏è <span data-lang="menu_settings">Ë®≠ÂÆö</span></div>
      </div>
      <button class="btn-block" style="background:#888;" onclick="closeModals()" data-lang="btn_close">Èñâ„Åò„Çã</button>
    </div>
  </div>

  <div class="top-bar">
    <div class="status-title" id="lblCurrentRoute">--</div>
    <div class="status-info" id="lblNavInfo">--</div>
  </div>

  <div class="fab-container">
    <button class="fab-btn" id="btnHistory" title="What is this place?">üìç</button>
    <button class="fab-btn" id="btnLocate" title="Current Location">‚óé</button>
  </div>

  <div class="bottom-bar">
    <button class="action-btn" id="btnMenuRoutes">
      <svg viewBox="0 0 24 24"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
      <span data-lang="menu_routes">Êé¢„Åô</span>
    </button>
    <button class="action-btn" id="btnMenuRecord">
      <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
      <span id="lblRecordBtn" data-lang="menu_record">Ë®òÈå≤</span>
    </button>
    <button class="action-btn" id="btnMenuReport">
      <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 12h-2v-2h2v2zm0-4h-2V6h2v4z"/></svg>
      <span data-lang="menu_report">Â†±Âëä</span>
    </button>
    <button class="action-btn" id="btnMenuSettings">
      <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.488.488 0 0 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32a.49.49 0 0 0-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
      <span data-lang="menu_settings">Ë®≠ÂÆö</span>
    </button>
  </div>

  <div class="modal-overlay" id="modalRoutes">
    <div class="modal-content">
      <h2 data-lang="title_select">Ë°óÈÅì„ÇíÈÅ∏Êäû</h2>
      <div id="routeListContainer" class="list-group"></div>
      <button class="btn-block" style="background:#888;" onclick="closeModals()" data-lang="btn_close">Èñâ„Åò„Çã</button>
    </div>
  </div>

  <div class="modal-overlay" id="modalRecord">
    <div class="modal-content">
      <h2 data-lang="title_record">Ë®òÈå≤ (GPS„É≠„Ç∞)</h2>
      <div id="recordStats" style="margin-bottom:15px; font-size:14px; line-height:1.6;">
        <span data-lang="lbl_status">Áä∂ÊÖã</span>: <span id="valRecStatus" style="font-weight:bold;">--</span><br>
        <span data-lang="lbl_points">ÁÇπÊï∞</span>: <span id="valRecPoints">0</span>
      </div>
      <button class="btn-block" id="btnStartStopRecord" style="background:var(--primary);" data-lang="btn_start">Ë®òÈå≤ÈñãÂßã</button>
      
      <div style="margin-top:16px; border-top:1px solid #eee; padding-top:10px;">
        <input type="file" id="inpGpxFile" accept=".gpx" style="display:none;">
        <button class="btn-block btn-secondary" onclick="document.getElementById('inpGpxFile').click()" data-lang="btn_import">GPXË™≠Ëæº</button>
      </div>

      <button class="btn-block btn-secondary" id="btnDownloadGpx" style="margin-top:10px;" data-lang="btn_gpx">GPX„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
      <button class="btn-block btn-danger" id="btnClearRecord" style="margin-top:10px;" data-lang="btn_clear">„ÇØ„É™„Ç¢</button>
      <button class="btn-block" style="background:#888; margin-top:20px;" onclick="closeModals()" data-lang="btn_close">Èñâ„Åò„Çã</button>
    </div>
  </div>

  <div class="modal-overlay" id="modalSettings">
      <div class="modal-content">
        <h2 data-lang="title_settings">Ë®≠ÂÆö</h2>
        
        <div class="settings-row">
          <span data-lang="lbl_lang">Ë®ÄË™û / Language</span>
          <button id="btnToggleLang" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc; background:#eee; cursor:pointer;">Êó•Êú¨Ë™û</button>
        </div>

        <div class="settings-row">
          <span data-lang="lbl_wakelock">ÁîªÈù¢Â∏∏ÊôÇÁÇπÁÅØ</span>
          <input type="checkbox" id="chkWakeLock" style="transform:scale(1.5);">
        </div>
        
        <button class="btn-block btn-secondary" style="margin-top:15px; background:#0088cc;" onclick="window.open('usage.html', '_blank')">
          üìñ <span data-lang="btn_usage">‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ</span>
        </button>
        <button class="btn-block" style="background:#888; margin-top:20px;" onclick="closeModals()" data-lang="btn_close">Èñâ„Åò„Çã</button>
      </div>
    </div>
  
  <div class="toast" id="toast"></div>

<div id="loadingModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:10000; align-items:center; justify-content:center; flex-direction:column;">
    <div style="border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 1.5s linear infinite;"></div>
    <p id="loadingText" style="margin-top:20px; font-weight:bold; color:#333; font-size:18px;">‰æç„ÅåËÄÉ„Åà‰∏≠...</p>
</div>

<style>
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<div id="aiModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:white; color:#333; padding:20px; border-radius:12px; width:90%; height:80%; display:flex; flex-direction:column; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
        
        <div id="aiContent" style="overflow-y:auto; flex-grow:1; font-size:16px; line-height:1.8; white-space: pre-wrap; margin-bottom:15px; padding:10px;"></div>
        
        <button onclick="document.getElementById('aiModal').style.display='none'" style="padding:15px; background:#0066cc; color:white; border:none; border-radius:8px; font-weight:bold; font-size:16px; cursor:pointer;">Èñâ„Åò„Çã</button>
    </div>
</div>

<script src="./assets/js/config.js?v=20260118" defer></script>
<script>
(() => {
  // =========================================
  // 0. ËæûÊõ∏„Éá„Éº„Çø (Dictionary)
  // =========================================
  const DICT = {
    ja: {
      menu_routes: "Êé¢„Åô", menu_record: "Ë®òÈå≤", menu_report: "Â†±Âëä", menu_settings: "Ë®≠ÂÆö",
      menu_samurai: "‰æç„ÅÆÁõÆ„ÅßË¶ã„Çã", 
      title_select: "Ë°óÈÅì„ÇíÈÅ∏Êäû", btn_close: "Èñâ„Åò„Çã",
      title_record: "Ë®òÈå≤ / GPX", lbl_status: "Áä∂ÊÖã", lbl_points: "ÁÇπÊï∞",
      btn_start: "Ë®òÈå≤ÈñãÂßã", btn_stop: "Ë®òÈå≤ÂÅúÊ≠¢", btn_gpx: "‰øùÂ≠ò(DL)", btn_clear: "„ÇØ„É™„Ç¢", btn_import: "GPXË™≠Ëæº",
      title_settings: "Ë®≠ÂÆö", lbl_lang: "Ë®ÄË™û / Language", lbl_wakelock: "ÁîªÈù¢Â∏∏ÊôÇÁÇπÁÅØ",
      btn_usage: "‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ",
      status_recording: "Ë®òÈå≤‰∏≠...", status_stopped: "ÂÅúÊ≠¢‰∏≠",
      msg_start: "Ë®òÈå≤„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü", msg_stop: "Ë®òÈå≤„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü", msg_clear: "„É≠„Ç∞„ÇíÊ∂àÂéª„Åó„Åæ„Åó„Åü",
      msg_no_data: "„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì", msg_loaded: "Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü", msg_error: "„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü",
      route_no_select: "Ë°óÈÅìÊú™ÈÅ∏Êäû", nav_info_init: "„ÄåÊé¢„Åô„Äç„Åã„ÇâË°óÈÅì„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ",
      route_loading: "Ë™≠Ëæº‰∏≠...", region_jp: "Êó•Êú¨ (‰∫îË°óÈÅì„ÉªÂ∑°Á§º)", region_world: "Êµ∑Â§ñ / „Åù„ÅÆ‰ªñ",
      // AIÈñ¢ÈÄ£
      msg_ai_analyzing: "ü§ñ Ëß£Êûê‰∏≠...\n„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ",
      msg_ai_history_search: "üìç Ê≠¥Âè≤„ÇíË™øÊüª‰∏≠...\n(ÁèæÂú®Âú∞Âë®Ëæ∫)",
      ai_samurai_prefix: "„Äê‰æç„ÅÆÁõÆ„Äë\n"
    },
    en: {
      menu_routes: "Routes", menu_record: "Record", menu_report: "Report", menu_settings: "Config",
      menu_samurai: "Samurai Vision",
      title_select: "Select Route", btn_close: "Close",
      title_record: "GPS & GPX", lbl_status: "Status", lbl_points: "Points",
      btn_start: "Start", btn_stop: "Stop", btn_gpx: "Download", btn_clear: "Clear", btn_import: "Import GPX",
      title_settings: "Settings", lbl_lang: "Language", lbl_wakelock: "Keep Screen On",
      btn_usage: "How to Use",
      status_recording: "Recording...", status_stopped: "Stopped",
      msg_start: "Recording started", msg_stop: "Recording stopped", msg_clear: "Log cleared",
      msg_no_data: "No data found", msg_loaded: "Route loaded", msg_error: "Error occurred",
      route_no_select: "No Route", nav_info_init: "Select a route from menu",
      route_loading: "Loading...", region_jp: "Japan", region_world: "World / Other",
      msg_ai_analyzing: "ü§ñ Analyzing...",
      msg_ai_history_search: "üìç Searching History...",
      ai_samurai_prefix: "[Samurai Vision]\n"
    }
  };

  // =========================================
  // 1. „Éá„Éº„ÇøÂÆöÁæ© (Êó•Ëã±ÂØæÂøú)
  // =========================================
  const WORLD_ROUTES = [
    { 
      region_ja: "Êó•Êú¨ ", region_en: "Japan", 
      routes: [
        { id: "tokaido", name_ja: "Êù±Êµ∑ÈÅì", name_en: "Tokaido", file: "data/tokaido_strict.geojson" },
        { id: "nakasendo", name_ja: "‰∏≠Â±±ÈÅì", name_en: "Nakasendo", file: "data/nakaendo_route.geojson" },
        { id: "koshu", name_ja: "Áî≤Â∑ûË°óÈÅì", name_en: "Koshu Kaido", file: "data/koshu_route.geojson" },
        { id: "nikko", name_ja: "Êó•ÂÖâË°óÈÅì", name_en: "Nikko Kaido", file: "data/nikko_route.geojson" },
        { id: "oshu", name_ja: "Â••Â∑ûË°óÈÅì", name_en: "Oshu Kaido", file: "data/oshu_route.geojson" },
        { id: "kumano", name_ja: "ÁÜäÈáéÂè§ÈÅìÔºà‰∏≠Ëæ∫Ë∑ØÔºâ", name_en: "Kumano Kodo", file: "data/kumano.geojson" },
        { id: "shikoku88", name_ja: "ÂõõÂõΩÈÅçË∑ØÔºà88„É∂ÊâÄÔºâ", name_en: "Shikoku Pilgrimage", file: "data/88tmples.geojson" },
        { id: "okunohosomichi", name_ja: "Â••„ÅÆÁ¥∞ÈÅì", name_en: "Oku no Hosomichi", file: "data/okunohosomichi.geojson" }
      ]
    },
    { 
      region_ja: "„Ç¢„Ç∏„Ç¢ / „É¶„Éº„É©„Ç∑„Ç¢", region_en: "Asia / Eurasia", 
      routes: [
        { id: "silkroad_uz", name_ja: "„Ç∑„É´„ÇØ„É≠„Éº„ÉâÔºà„Ç¶„Ç∫„Éô„Ç≠„Çπ„Çø„É≥Ôºâ", name_en: "Silk Road (Uzbekistan)", file: "data/silkroad_uz.geojson" },
        { id: "lycian", name_ja: "„É™„Ç≠„Ç¢„É≥„Éª„Ç¶„Çß„Ç§", name_en: "Lycian Way", file: "data/lycianway.geojson" },
        { id: "jeju", name_ja: "Ê∏àÂ∑û„Ç™„É´„É¨", name_en: "Jeju Olle Trail", file: "data/jot.geojson" },
        { id: "teahorse", name_ja: "Ëå∂È¶¨Âè§ÈÅì", name_en: "Tea Horse Road", file: "data/teahorseroad.geojson" },
        { id: "jesustrail", name_ja: "„Ç∏„Éº„Ç∂„Çπ„Éª„Éà„É¨„Ç§„É´", name_en: "Jesus Trail", file: "data/jesustrail.geojson" },
        { id: "jordantrail", name_ja: "„É®„É´„ÉÄ„É≥„Éª„Éà„É¨„Ç§„É´", name_en: "Jordan Trail", file: "data/jordantrail.geojson" }
      ]
    },
    { 
      region_ja: "„É®„Éº„É≠„ÉÉ„Éë", region_en: "Europe", 
      routes: [
        { id: "appia", name_ja: "„Ç¢„ÉÉ„Éî„Ç¢Ë°óÈÅì", name_en: "Appian Way", file: "data/appia.geojson" },
        { id: "tmb", name_ja: "„ÉÑ„Éº„É´„Éª„Éâ„Éª„É¢„É≥„Éñ„É©„É≥", name_en: "Tour du Mont Blanc", file: "data/tmb.geojson" },
        { id: "camino", name_ja: "„Çµ„É≥„ÉÜ„Ç£„Ç¢„Ç¥Â∑°Á§ºÔºà„Éï„É©„É≥„Çπ‰∫∫„ÅÆÈÅìÔºâ", name_en: "Camino de Santiago (Franc√©s)", file: "data/camino_frances.geojson" },
        { id: "francigena", name_ja: "„Éï„É©„É≥„ÉÅ„Ç∏„Çß„ÉäË°óÈÅì", name_en: "Via Francigena", file: "data/viafrancigena.geojson" },
        { id: "whw", name_ja: "„Ç¶„Çß„Çπ„Éà„Éª„Éè„Ç§„É©„É≥„Éâ„Éª„Ç¶„Çß„Ç§", name_en: "West Highland Way", file: "data/whway.geojson" },
        { id: "hadrian", name_ja: "„Éè„Éâ„É™„Ç¢„Éå„Çπ„ÅÆÈï∑Âüé„Éë„Çπ", name_en: "Hadrian's Wall Path", file: "data/hwp.geojson" },
        { id: "stolav", name_ja: "ËÅñ„Ç™„É©„Éï„ÅÆÈÅì", name_en: "St. Olav's Way", file: "data/sow.geojson" },
        { id: "romanticroad", name_ja: "„É≠„Éû„É≥„ÉÅ„ÉÉ„ÇØË°óÈÅì", name_en: "Romantic Road", file: "data/romanticroad.geojson" },
        { id: "viaalpina", name_ja: "„É¥„Ç£„Ç¢„Éª„Ç¢„É´„Éî„Éä", name_en: "Via Alpina", file: "data/viaalpina.geojson" },
        { id: "cotswold", name_ja: "„Ç≥„ÉÉ„ÉÑ„Ç¶„Ç©„É´„Ç∫„Éª„Ç¶„Çß„Ç§", name_en: "Cotswold Way", file: "data/cotswoldway.geojson" },
        { id: "kungsleden", name_ja: "„ÇØ„É≥„Ç∞„Çπ„É¨„Éº„Éá„É≥", name_en: "Kungsleden", file: "data/kungsleden.geojson" }
      ]
    },
    { 
      region_ja: "„Ç¢„É°„É™„Ç´Â§ßÈô∏", region_en: "Americas", 
      routes: [
        { id: "appalachian", name_ja: "„Ç¢„Éë„É©„ÉÅ„Ç¢„É≥„Éª„Éà„É¨„Ç§„É´", name_en: "Appalachian Trail", file: "data/appalachian.geojson" },
        { id: "route66", name_ja: "„É´„Éº„Éà66", name_en: "Route 66", file: "data/route66.geojson" },
        { id: "inca", name_ja: "„Ç§„É≥„Ç´ÈÅì", name_en: "Inca Trail", file: "data/inca.geojson" },
        { id: "pct", name_ja: "„Éë„Ç∑„Éï„Ç£„ÉÉ„ÇØ„Éª„ÇØ„É¨„Çπ„Éà„Éª„Éà„É¨„Ç§„É´ (PCT)", name_en: "Pacific Crest Trail", file: "data/pct.geojson" },
        { id: "jmt", name_ja: "„Ç∏„Éß„É≥„Éª„Éü„É•„Éº„Ç¢„Éª„Éà„É¨„Ç§„É´ (JMT)", name_en: "John Muir Trail", file: "data/jmt.geojson" },
        { id: "qhapaqnan", name_ja: "„Ç´„Éë„ÉÉ„ÇØ„Éª„Éã„É£„É≥Ôºà„Ç¢„É≥„Éá„Çπ„Éª„É≠„Éº„ÉâÔºâ", name_en: "Qhapaq Nan", file: "data/qhapaqnan.geojson" }
      ]
    },
    {
      region_ja: "„Ç™„Çª„Ç¢„Éã„Ç¢", region_en: "Oceania",
      routes: [
        { id: "milford", name_ja: "„Éü„É´„Éï„Ç©„Éº„Éâ„Éª„Éà„É©„ÉÉ„ÇØ", name_en: "Milford Track", file: "data/milfordtrack.geojson" },
        { id: "greatocean", name_ja: "„Ç∞„É¨„Éº„Éà„Éª„Ç™„Éº„Ç∑„É£„É≥„Éª„Ç¶„Ç©„Éº„ÇØ", name_en: "Great Ocean Walk", file: "data/greatoceanwalk.geojson" }
      ]
    }
  ];

  // =========================================
  // 1.5 URL„Éë„É©„É°„Éº„ÇøÂá¶ÁêÜ
  // =========================================
  const urlParams = new URLSearchParams(window.location.search);
  const paramLang = urlParams.get('lang');
  if (paramLang && (paramLang === 'ja' || paramLang === 'en')) {
    localStorage.setItem('kaido_lang', paramLang);
  }
  const paramRoute = urlParams.get('route');
  let initialRouteId = null;
  if (paramRoute) {
    let found = false;
    for (const group of WORLD_ROUTES) {
      if (group.routes.some(r => r.id === paramRoute)) {
        found = true;
        break;
      }
    }
    if (found) {
      initialRouteId = paramRoute;
      localStorage.setItem('kaido_active_route', initialRouteId);
    }
  }

  // =========================================
  // 2. „Ç¢„Éó„É™„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
  // =========================================
  const AppState = {
    lang: localStorage.getItem('kaido_lang') || 'ja',
    currentRouteId: initialRouteId || localStorage.getItem('kaido_active_route') || null,
    trackPoints: JSON.parse(localStorage.getItem('kaido_track_points') || '[]'),
    isRecording: false,
    watchId: null,
    currentPos: null,
    layers: {}
  };

  const map = L.map('map', { zoomControl: false }).setView([35.681, 139.767], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  map.on("moveend", () => {
    if (!AppState.isLoadingRoute) {
      const c = map.getCenter();
      localStorage.setItem("sr_lat", String(c.lat));
      localStorage.setItem("sr_lng", String(c.lng));
      localStorage.setItem("sr_zoom", String(map.getZoom()));
    }
  });

  function restoreMapPosition() {
    if (initialRouteId) return;
    const lat = parseFloat(localStorage.getItem("sr_lat"));
    const lng = parseFloat(localStorage.getItem("sr_lng"));
    const zoom = parseFloat(localStorage.getItem("sr_zoom"));
    if (isFinite(lat) && isFinite(lng) && isFinite(zoom)){
      map.setView([lat,lng], zoom, { animate:false });
    }
  }

  // =========================================
  // 3. Âü∫Êú¨Ê©üËÉΩ & ÁøªË®≥„Ç∑„Çπ„ÉÜ„É†
  // =========================================
  
  function t(key) { return DICT[AppState.lang][key] || key; }

  function updateLanguage() {
    document.querySelectorAll('[data-lang]').forEach(el => {
      el.textContent = t(el.dataset.lang);
    });
    renderRouteMenu();
    updateRecordStats();
    renderRecordButtonState();
    updateTopBarText();
    document.getElementById('btnToggleLang').textContent = (AppState.lang === 'ja') ? "Êó•Êú¨Ë™û" : "English";
  }

  function toggleLanguage() {
    AppState.lang = (AppState.lang === 'ja') ? 'en' : 'ja';
    localStorage.setItem('kaido_lang', AppState.lang);
    updateLanguage();
  }

  function updateTopBarText() {
    if (!AppState.currentRouteId) {
      document.getElementById('lblCurrentRoute').textContent = t('route_no_select');
      document.getElementById('lblNavInfo').textContent = t('nav_info_init');
      return;
    }
    let name = "Unknown";
    for (const group of WORLD_ROUTES) {
      const found = group.routes.find(r => r.id === AppState.currentRouteId);
      if (found) { name = (AppState.lang === 'ja') ? found.name_ja : found.name_en; break; }
    }
    document.getElementById('lblCurrentRoute').textContent = name;
  }

  function drawTrack() {
    if (AppState.layers.trackLine) AppState.layers.trackLine.remove();
    if (AppState.trackPoints.length < 1) return;
    const latlngs = AppState.trackPoints.map(p => [p.lat, p.lng]);
    AppState.layers.trackLine = L.polyline(latlngs, { color: 'blue', weight: 4, opacity: 0.8 }).addTo(map);
  }

  function loadActiveRoute() {
    if (!AppState.currentRouteId) { updateTopBarText(); return; }

    let targetRoute = null;
    for (const group of WORLD_ROUTES) {
      const found = group.routes.find(r => r.id === AppState.currentRouteId);
      if (found) { targetRoute = found; break; }
    }
    if (!targetRoute) return;

    updateTopBarText();
    document.getElementById('lblNavInfo').textContent = t('route_loading');
    if (AppState.layers.route) AppState.layers.route.remove();
    AppState.isLoadingRoute = true;

    fetch(targetRoute.file)
      .then(res => {
        if (!res.ok) throw new Error("File not found");
        return res.json();
      })
      .then(geoJson => {
        AppState.layers.route = L.geoJSON(geoJson, {
          style: { color: '#cc0000', weight: 5, opacity: 0.7 }
        }).addTo(map);
        map.fitBounds(AppState.layers.route.getBounds(), { padding: [50, 50] });
        document.getElementById('lblNavInfo').textContent = t('msg_loaded');
        setTimeout(() => { AppState.isLoadingRoute = false; }, 1000);
      })
      .catch(err => {
        console.error(err);
        document.getElementById('lblNavInfo').textContent = "Error";
        showToast(t('msg_error'));
        AppState.isLoadingRoute = false;
      });
  }

   // Êñ∞„Åó„ÅÑË°®Á§∫Èñ¢Êï∞
   function showAIResult(text) {
       const modal = document.getElementById('aiModal');
       const content = document.getElementById('aiContent');
       
       // ‰∏≠Ë∫´„Çí„Çª„ÉÉ„Éà„Åó„Å¶ÁîªÈù¢„ÇíË°®Á§∫
       content.textContent = text;
       modal.style.display = "flex"; 
   }

/ „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢„ÇíÂá∫„Åô
function showLoading() {
    const modal = document.getElementById('loadingModal');
    const text = document.getElementById('loadingText');
    
    // Ë®ÄË™û„Å´„Çà„Å£„Å¶„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂ§â„Åà„Çã
    if (typeof currentLang !== 'undefined' && currentLang === 'en') {
        text.textContent = "The Samurai is thinking...";
    } else {
        text.textContent = "‰æç„ÅåËÄÉ„Åà‰∏≠...";
    }
    
    modal.style.display = "flex";
}

// „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢„ÇíÊ∂à„Åô
function hideLoading() {
    document.getElementById('loadingModal').style.display = "none";
}

  // --- AI / Cloudflare Workers ÈÄ£Êê∫ ---
  async function callGemini(prompt, image = null) {
    // Ëá™Ë∫´„ÅÆCloudflare Workers„ÅÆ„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà (/gemini)
    const base = (window.AI_HTTP || location.origin).replace(/\/$/, "");
    const endpoint = `${base}/ai/samuraimap`;
    const payload = { prompt };
    if (image) payload.image = image;

    try {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      // „É¨„Çπ„Éù„É≥„Çπ„ÅÆÂΩ¢Âºè„Å´„ÅÇ„Çè„Åõ„Å¶Ë™øÊï¥
      const resultText = json.text || json.candidates?.[0]?.content?.parts?.[0]?.text || JSON.stringify(json);
      return resultText;
    } catch (e) {
      throw new Error(e.message);
    }
  }

  // --- ‰æç„ÅÆÁõÆ (AI Camera) ---
async function processSamuraiImage(base64) {
    // 1. „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈñãÂßã
    showLoading();

    let prompt = "";

    // 2. Ë®ÄË™ûÂà§ÂÆö
    if (typeof currentLang !== 'undefined' && currentLang === 'en') {
        // „ÄêËã±Ë™û„É¢„Éº„Éâ„Äë
        prompt = `Where is this location?
Based on the image, please explain the scenery and its historical context (especially related to old Japanese roads if possible).
Please answer in English.
[Constraint]: Do not include titles. Start directly with the content.`;
    } else {
        // „ÄêÊó•Êú¨Ë™û„É¢„Éº„Éâ„Äë
        prompt = `„Åì„Åì„Åæ„Åß„ÅÆ‰ºöË©±„ÅØÂøò„Çå„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
„Åì„ÅÆÁîªÂÉè„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü
Ë°óÈÅìÊ≠©„Åç„ÅÆÊóÖ„ÅÆÈÄî‰∏≠„ÅßÊíÆÂΩ±„Åï„Çå„Åü„ÇÇ„ÅÆ„Åß„Åô„ÄÇ
ÁîªÂÉè„Åã„ÇâË™≠„ÅøÂèñ„Çå„ÇãÈ¢®ÊôØ„ÇÑ„ÄÅÊ≠¥Âè≤ÁöÑ„Å™ÊñáËÑàÔºàÂÆøÂ†¥Áî∫„ÇÑÂè≤Ë∑°„Å™„Å©Ôºâ„Å´„Å§„ÅÑ„Å¶Ë©≥„Åó„ÅèËß£Ë™¨„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
„ÄêÂà∂Á¥Ñ‰∫ãÈ†Ö„Äë„Çø„Ç§„Éà„É´‰∏çË¶Å„ÄÇ„ÅÑ„Åç„Å™„ÇäÊú¨Êñá„Åã„ÇâÂßã„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
    }

    try {
        const answer = await callGemini(prompt, base64);
        
        // 3. „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁµÇ‰∫Ü
        hideLoading();
        showAIResult(answer);

    } catch (e) {
        hideLoading();
        console.error(e);
        alert(typeof t === 'function' ? t('error_occurred') : "„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü");
    }
}
  
  // --- „Åì„Åì„ÅØ„Å©„Çì„Å™Â†¥ÊâÄÔºü (History Guide) ---
async function askHistoryByGPS(latitude, longitude) {
    // 1. „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈñãÂßã
    showLoading();

    let prompt = "";

    // 2. Ë®ÄË™ûÂà§ÂÆö„Åó„Å¶„Éó„É≠„É≥„Éó„Éà„ÇíÂàá„ÇäÊõø„Åà
    if (typeof currentLang !== 'undefined' && currentLang === 'en') {
        // „ÄêËã±Ë™û„É¢„Éº„Éâ„Äë
        prompt = `I am currently at Latitude ${latitude}, Longitude ${longitude}.
Please act as a historical guide.
Explain the history of this location (or the nearest historical road/post town) specifically focusing on the Edo period.
Please answer in English.
[Constraint]: Do not include any titles or headings. Start directly with the explanation.`;
    } else {
        // „ÄêÊó•Êú¨Ë™û„É¢„Éº„Éâ„Äë
        prompt = `ÁßÅ„ÅØ‰ªä„ÄÅÁ∑ØÂ∫¶${latitude}„ÄÅÁµåÂ∫¶${longitude}„ÅÆÂ†¥ÊâÄ„Å´„ÅÑ„Åæ„Åô„ÄÇ
„Åì„ÅÆÂ†¥ÊâÄÔºà„Åæ„Åü„ÅØ‰∏ÄÁï™Ëøë„ÅÑÊ≠¥Âè≤ÁöÑ„Å™Ë°óÈÅì„ÇÑÂÆøÂ†¥Áî∫Ôºâ„Å´„Å§„ÅÑ„Å¶„ÄÅ
„ÄåÊòî„ÅÆÊóÖ‰∫∫„Å´„Å™„Å£„ÅüÊ∞óÂàÜ„Äç„ÅßÊ•Ω„Åó„ÇÅ„Çã„Çà„ÅÜ„Å™Ê≠¥Âè≤ÁöÑ„Ç®„Éî„ÇΩ„Éº„Éâ„ÇÑ„ÄÅÊ±üÊà∏ÊôÇ‰ª£„Å´‰Ωï„Åå„ÅÇ„Å£„Åü„Åã„ÇíË©≥„Åó„ÅèÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
„ÄêÂà∂Á¥Ñ‰∫ãÈ†Ö„Äë
„Éª„Çø„Ç§„Éà„É´„ÇÑË¶ãÂá∫„Åó„ÅØ‰∏ÄÂàáÊõ∏„Åã„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
„ÉªÊå®Êã∂„ÇÇ‰∏çË¶Å„Åß„Åô„ÄÇ„ÅÑ„Åç„Å™„ÇäÊú¨Êñá„Åã„ÇâÊõ∏„ÅçÂßã„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
    }

    try {
        const answer = await callGemini(prompt);
        // 3. „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁµÇ‰∫Ü
        hideLoading();
        showAIResult(answer);
    } catch (e) {
        hideLoading();
        console.error(e);
        alert(typeof t === 'function' ? t('error_occurred') : "„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü");
    }
}

  // --- Ë®òÈå≤Ê©üËÉΩ„Å™„Å© (Â§âÊõ¥„Å™„Åó) ---
  function updateRecordStats() {
    const pts = AppState.trackPoints;
    document.getElementById('valRecStatus').textContent = AppState.isRecording ? t('status_recording') : t('status_stopped');
    document.getElementById('valRecStatus').style.color = AppState.isRecording ? "#cc0000" : "#333";
    document.getElementById('valRecPoints').textContent = pts.length;
    const btnText = document.getElementById('lblRecordBtn');
    btnText.textContent = AppState.isRecording ? "STOP" : t('menu_record');
    btnText.style.color = AppState.isRecording ? "#cc0000" : "";
  }
  function renderRecordButtonState(){
    const btn = document.getElementById('btnStartStopRecord');
    btn.textContent = AppState.isRecording ? t('btn_stop') : t('btn_start');
    btn.className = AppState.isRecording ? "btn-block btn-danger" : "btn-block";
  }
  function toggleRecord() {
    AppState.isRecording = !AppState.isRecording;
    if (AppState.isRecording) {
      if (!navigator.geolocation) { alert("GPS Not Supported"); AppState.isRecording=false; return; }
      AppState.watchId = navigator.geolocation.watchPosition(
        pos => {
          const p = { lat: pos.coords.latitude, lng: pos.coords.longitude, t: Date.now() };
          AppState.trackPoints.push(p);
          localStorage.setItem('kaido_track_points', JSON.stringify(AppState.trackPoints));
          updateRecordStats();
          drawTrack();
        },
        err => { console.error(err); },
        { enableHighAccuracy: true }
      );
      showToast(t('msg_start'));
    } else {
      if (AppState.watchId) navigator.geolocation.clearWatch(AppState.watchId);
      showToast(t('msg_stop'));
    }
    updateRecordStats();
    renderRecordButtonState();
  }
  function clearRecord() {
    if(!confirm("Clear log?")) return;
    AppState.trackPoints = [];
    localStorage.setItem('kaido_track_points', '[]');
    if(AppState.layers.trackLine) AppState.layers.trackLine.remove();
    updateRecordStats();
    showToast(t('msg_clear'));
  }
  function downloadGpx() {
    const pts = AppState.trackPoints;
    if (pts.length === 0) { alert(t('msg_no_data')); return; }
    const now = new Date();
    const defaultName = `track_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
    let fileName = prompt("File Name", defaultName);
    if (fileName === null) return;
    if (!fileName.trim()) fileName = defaultName;
    if (!fileName.toLowerCase().endsWith('.gpx')) fileName += '.gpx';
    let gpx = `<?xml version="1.0"?><gpx version="1.1"><trk><trkseg>`;
    pts.forEach(p => {
      gpx += `<trkpt lat="${p.lat}" lon="${p.lng}"><time>${new Date(p.t).toISOString()}</time></trkpt>`;
    });
    gpx += `</trkseg></trk></gpx>`;
    const blob = new Blob([gpx], {type: "application/gpx+xml"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = fileName;
    document.body.appendChild(a); a.click(); a.remove();
  }
  function importGpx(event) {
    const file = event.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(text, "text/xml");
      const trkpts = xmlDoc.getElementsByTagName("trkpt");
      AppState.trackPoints = []; 
      for (let i = 0; i < trkpts.length; i++) {
        const lat = parseFloat(trkpts[i].getAttribute("lat"));
        const lon = parseFloat(trkpts[i].getAttribute("lon"));
        const timeTag = trkpts[i].getElementsByTagName("time")[0];
        const time = timeTag ? new Date(timeTag.textContent).getTime() : Date.now();
        AppState.trackPoints.push({ lat: lat, lng: lon, t: time });
      }
      localStorage.setItem('kaido_track_points', JSON.stringify(AppState.trackPoints));
      drawTrack();
      updateRecordStats();
      if(AppState.trackPoints.length > 0) map.fitBounds(AppState.layers.trackLine.getBounds());
      showToast(t('msg_loaded'));
      closeModals();
    };
    reader.readAsText(file);
  }

  function openReportForm() {
    const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSctfcD7qgXA3t7X1bWQnXiqyTSCdh2iy1uuM07otO4xGGoU_g/viewform";
    const ID_LAT   = "entry.1725964949";
    const ID_LNG   = "entry.1039750529";
    const ID_ROUTE = "entry.2062767095";
    let params = [];
    if (AppState.currentPos) {
      params.push(`${ID_LAT}=${AppState.currentPos.lat}`);
      params.push(`${ID_LNG}=${AppState.currentPos.lng}`);
    }
    if (AppState.currentRouteId) {
      let name = AppState.currentRouteId;
      for (const group of WORLD_ROUTES) {
        const found = group.routes.find(r => r.id === AppState.currentRouteId);
        if(found) name = found.name_ja;
      }
      params.push(`${ID_ROUTE}=${encodeURIComponent(name)}`);
    }
    window.open(`${formUrl}?${params.join('&')}`, "_blank"); 
  }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  }
  window.closeModals = function() {
    document.querySelectorAll('.modal-overlay').forEach(e => e.classList.remove('open'));
  };
  function openModal(id) {
    closeModals();
    document.getElementById(id).classList.add('open');
  }
  function renderRouteMenu() {
    const container = document.getElementById('routeListContainer');
    container.innerHTML = "";
    WORLD_ROUTES.forEach(group => {
      const h3 = document.createElement('div');
      h3.style.cssText = "font-size:12px; color:#666; margin-top:10px; margin-bottom:4px; font-weight:bold;";
      h3.textContent = (AppState.lang === 'ja') ? group.region_ja : group.region_en;
      container.appendChild(h3);
      group.routes.forEach(route => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.textContent = (AppState.lang === 'ja') ? route.name_ja : route.name_en;
        div.onclick = () => {
          AppState.currentRouteId = route.id;
          localStorage.setItem('kaido_active_route', route.id);
          loadActiveRoute();
          closeModals();
          showToast(div.textContent + " Selected");
        };
        container.appendChild(div);
      });
    });
  }

  // =========================================
  // 4. „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
  // =========================================
  document.getElementById('btnMenuRoutes').onclick = () => openModal('modalRoutes');
  document.getElementById('btnMenuRecord').onclick = () => openModal('modalRecord');
  document.getElementById('btnMenuSettings').onclick = () => openModal('modalSettings');
  document.getElementById('btnMenuReport').onclick = openReportForm;
  document.getElementById('btnStartStopRecord').onclick = () => toggleRecord();
  document.getElementById('btnClearRecord').onclick = clearRecord;
  document.getElementById('btnDownloadGpx').onclick = downloadGpx;
  document.getElementById('btnToggleLang').onclick = toggleLanguage;
  document.getElementById('inpGpxFile').addEventListener('change', importGpx);
  
  document.getElementById('btnHamburger').onclick = () => openModal('modalMainMenu');
  document.getElementById('menuItemRoutes').onclick = () => { closeModals(); openModal('modalRoutes'); };
  document.getElementById('menuItemRecord').onclick = () => { closeModals(); openModal('modalRecord'); };
  document.getElementById('menuItemReport').onclick = () => { closeModals(); openReportForm(); };
  document.getElementById('menuItemSettings').onclick = () => { closeModals(); openModal('modalSettings'); };

  // ‰æç„ÅÆÁõÆ
  document.getElementById('menuItemSamurai').onclick = () => {
    closeModals();
    document.getElementById('inpSamuraiCamera').click();
  };
  document.getElementById('inpSamuraiCamera').onchange = (e) => processSamuraiImage(e.target);

  // Ê≠¥Âè≤„Ç¨„Ç§„Éâ
  document.getElementById('btnHistory').onclick = askHistoryByGPS;

  // ÁèæÂú®Âú∞ÁßªÂãï
  document.getElementById('btnLocate').onclick = () => {
    if(!navigator.geolocation) return;
    showToast(t('route_loading'));
    navigator.geolocation.getCurrentPosition(pos => {
      const {latitude, longitude} = pos.coords;
      AppState.currentPos = { lat: latitude, lng: longitude };
      map.setView([latitude, longitude], 15);
      if(AppState.layers.me) AppState.layers.me.remove();
      AppState.layers.me = L.circleMarker([latitude, longitude], { radius:8, color:'white', fillColor:'#0066cc', fillOpacity:1 }).addTo(map);
    }, err => alert("GPS Error: " + err.message));
  };

  // ÂàùÊúüÂåñ
  restoreMapPosition();
  updateLanguage();
  if (AppState.currentRouteId) loadActiveRoute();
  drawTrack();

})();
</script>
</body>
</html>