<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Global Kaido Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="./assets/css/worldmap_style.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

  <div id="map"></div>

  <button class="hamburger" id="btnHamburger" aria-label="menu">
    <div class="bars"><span></span><span></span><span></span></div>
  </button>

  <div class="modal-overlay" id="modalMainMenu">
    <div class="modal-content">
      <h2>Menu</h2>
      <div class="list-group">
        <div class="list-item" id="menuItemRoutes">🗺️ <span data-lang="menu_routes">探す</span></div>
        <div class="list-item" id="menuItemRecord">⏺️ <span data-lang="menu_record">記録</span></div>
        <div class="list-item" id="menuItemRouteEdit">✍️ <span data-lang="menu_routeedit">ルート作成</span></div>
        <div class="list-item" id="menuItemTrace">✍️ <span data-lang="menu_trace">なぞりゲーム</span></div>
        
        <div class="list-item item-samurai" id="menuItemSamurai">
          📷 <span data-lang="menu_samurai">侍の目で見る</span>
        </div>
        
        <div class="list-item item-onsen" id="menuItemOnsen">
          ♨️ <span data-lang="menu_onsen">温泉を探す(現在地)</span>
        </div>
        <div class="list-item item-food" id="menuItemFood">
          🍴 <span data-lang="menu_food">地元の食事・休憩(現在地)</span>
        </div>

        <input type="file" id="inpSamuraiCamera" accept="image/*" capture="environment" style="display:none;">

        <div class="list-item" id="menuItemReport">📝 <span data-lang="menu_report">報告</span></div>
        <div class="list-item" id="menuItemSettings">⚙️ <span data-lang="menu_settings">設定</span></div>
      </div>
      <button class="btn-block" style="background:#888;" onclick="closeModals()" data-lang="btn_close">閉じる</button>
    </div>
  </div>

  <div class="modal-overlay" id="modalRouteEdit">
    <div class="modal-content trace-modal">
      <h2 data-lang="title_routeedit">ルート作成</h2>

      <div class="trace-actions">
        <button class="btn-block trace-btn" id="btnREStart" data-lang="re_start">Start（描画）</button>

        <div class="trace-actions-row">
          <button class="btn-half" id="btnREUndo" data-lang="re_undo">Undo</button>
          <button class="btn-half" id="btnREReset" data-lang="re_reset">Reset</button>
        </div>

        <div class="trace-actions-row">
          <button class="btn-half" id="btnREFinish" data-lang="re_finish">Finish</button>
          <button class="btn-half" id="btnREExport" data-lang="re_export">Export</button>
        </div>

        <label class="trace-toggle">
          <input type="checkbox" id="chkRERef" checked />
          <span data-lang="re_showref">参照ルートを表示</span>
        </label>

        <label class="trace-toggle">
          <input type="checkbox" id="chkRESnap" />
          <span data-lang="re_snap">参照ルートへスナップ（近い時だけ）</span>
        </label>

        <div class="trace-actions-row">
          <button class="btn-half" id="btnRESimplify" data-lang="re_simplify">簡略化</button>
          <div class="re-slider-wrap">
            <div class="re-slider-label"><span data-lang="re_tolerance">許容</span>: <b id="lblRETol">15m</b></div>
            <input type="range" id="rngRESimplify" min="2" max="80" step="1" value="15" />
          </div>
        </div>

        <label class="trace-toggle">
          <input type="checkbox" id="chkREEdit" />
          <span data-lang="re_vertex_edit">頂点編集（ドラッグ）</span>
        </label>

        <label class="trace-toggle">
          <span data-lang="re_name">名前</span>
          <input class="input" id="inpREName" placeholder="例：中山道（妻籠→馬籠）" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:10px;" />
        </label>

        <label class="trace-toggle">
          <span data-lang="re_note">メモ</span>
          <input class="input" id="inpRENote" placeholder="例：現地でなぞった復元版" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:10px;" />
        </label>
      </div>

      <div class="trace-result" id="reResult" style="display:none;">
        <h3 data-lang="re_result">プレビュー</h3>
        <div class="trace-breakdown" id="reBreakdown">--</div>
      </div>

      <button class="btn-block" style="background:#888;" onclick="closeModals();" data-lang="btn_close">閉じる</button>
    </div>
  </div>


  <div class="top-bar">
    <div class="status-title" id="lblCurrentRoute">--</div>
    <div class="status-info" id="lblNavInfo">--</div>
  </div>

  <div class="fab-container">
    <button class="fab-btn" id="btnPocket" title="Pocket Mode" style="background:#111; color:#ccc; font-size:20px; border:1px solid #333;">🌙</button>
    <button class="fab-btn" id="btnHistory" title="What is this place?">📍</button>
    <button class="fab-btn" id="btnLocate" title="Current Location">◎</button>
  </div>

  <div class="bottom-bar">
    <button class="action-btn" id="btnMenuRoutes">
      <svg viewBox="0 0 24 24"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
      <span data-lang="menu_routes">探す</span>
    </button>
    <button class="action-btn" id="btnMenuRecord">
      <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
      <span id="lblRecordBtn" data-lang="menu_record">記録</span>
    </button>
    <button class="action-btn" id="btnMenuReport">
      <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 12h-2v-2h2v2zm0-4h-2V6h2v4z"/></svg>
      <span data-lang="menu_report">報告</span>
    </button>
    <button class="action-btn" id="btnMenuSettings">
      <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.488.488 0 0 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32a.49.49 0 0 0-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
      <span data-lang="menu_settings">設定</span>
    </button>
  </div>

  <div class="modal-overlay" id="modalRoutes">
    <div class="modal-content">
      <h2 data-lang="title_select">街道を選択</h2>
      <div id="routeListContainer" class="list-group"></div>
      <button class="btn-block" style="background:#888;" onclick="closeModals()" data-lang="btn_close">閉じる</button>
      <button class="btn-block btn-danger"
          onclick="if(window.RouteEditor) RouteEditor.stop(); document.getElementById('modalRouteEdit')?.classList.remove('open','minimized');">
       終了
      </button>
    </div>
  </div>

  <div class="modal-overlay" id="modalRecord">
    <div class="modal-content">
      <h2 data-lang="title_record">記録 / GPX</h2>
      
      <div id="recordStats" style="margin-bottom:20px; font-size:14px; line-height:1.6; background:#f5f5f5; padding:12px; border-radius:8px;">
        <span data-lang="lbl_status">状態</span>: <span id="valRecStatus" style="font-weight:bold;">停止中</span>
        <span id="unsavedBadge" style="color:#d9534f; font-size:12px; margin-left:8px; font-weight:bold; display:none;">(未保存)</span><br>
        <span data-lang="lbl_points">現在のデータ点数</span>: <span id="valRecPoints" style="font-weight:bold;">0</span>
      </div>

      <div style="margin-bottom:20px;">
        <button class="btn-block" id="btnStartStopRecord" style="background:var(--primary); margin-bottom:10px;" data-lang="btn_start">記録開始</button>
        <button class="btn-block btn-secondary" id="btnDownloadGpx" data-lang="btn_gpx">GPXを保存 (ダウンロード)</button>
      </div>
      
      <div style="margin-bottom:20px; border-top:1px dashed #ccc; padding-top:15px;">
        <input type="file" id="inpGpxFile" accept=".gpx" style="display:none;">
        <button class="btn-block btn-secondary" onclick="document.getElementById('inpGpxFile').click()" data-lang="btn_import">GPX読込 (外部ファイル)</button>
      </div>

      <div style="border-top:1px dashed #ccc; padding-top:15px;">
        <button class="btn-block btn-danger" id="btnClearRecord" style="margin-bottom:10px;" data-lang="btn_clear">記録・表示をリセット</button>
        <button class="btn-block" style="background:#888;" onclick="closeModals()" data-lang="btn_close">閉じる</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modalSettings">
      <div class="modal-content">
        <h2 data-lang="title_settings">設定</h2>
        
        <div class="settings-row">
          <span data-lang="lbl_lang">言語 / Language</span>
          <button id="btnToggleLang" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc; background:#eee; cursor:pointer;">日本語</button>
        </div>
        <div class="settings-row" style="flex-direction: column; align-items: flex-start;">
          <span data-lang="lbl_search_cond">検索時の詳細条件</span>
          <textarea id="inpSearchCond" rows="3" style="width: 100%; margin-top: 5px; padding: 8px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; font-family: inherit;" placeholder="例：車椅子対応、子供連れ、予算1000円以内など"></textarea>
        </div>

        <div class="settings-row">
          <span data-lang="lbl_wakelock">画面常時点灯</span>
          <input type="checkbox" id="chkWakeLock" style="transform:scale(1.5);">
        </div>

        <div class="settings-row">
          <span data-lang="lbl_autospeech">🔊 自動読み上げ</span>
          <input type="checkbox" id="chkAutoSpeech" style="transform:scale(1.5);">
        </div>
        
        <button class="btn-block btn-secondary" style="margin-top:15px; background:#0088cc;" onclick="window.open('worldmap_usage.html', '_blank')">
          📖 <span data-lang="btn_usage">使い方ガイド</span>
        </button>
        <button class="btn-block" style="background:#888; margin-top:20px;" onclick="closeModals()" data-lang="btn_close">閉じる</button>
      </div>
    </div>
  
  <div class="toast" id="toast"></div>

<div id="loadingModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:10000; align-items:center; justify-content:center; flex-direction:column;">
    <div style="border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 1.5s linear infinite;"></div>
    <p id="loadingText" style="margin-top:20px; font-weight:bold; color:#333; font-size:18px;">侍が考え中...</p>
</div>

<div id="aiModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:white; color:#333; padding:20px; border-radius:12px; width:90%; height:80%; display:flex; flex-direction:column; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
        
        <div style="display:flex; justify-content:flex-end; padding-bottom:10px; border-bottom:1px solid #eee; margin-bottom:10px;">
           <button id="btnSpeechToggle" style="background:none; border:1px solid #0066cc; color:#0066cc; border-radius:20px; padding:5px 15px; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:5px;">
             <span>🔊</span> <span id="lblSpeechBtn">読み上げ</span>
           </button>
        </div>

        <div id="aiContent" style="overflow-y:auto; flex-grow:1; font-size:16px; line-height:1.8; white-space: pre-wrap; margin-bottom:15px; padding:10px;"></div>
        
        <button onclick="document.getElementById('aiModal').style.display='none'; stopSpeech();" style="padding:15px; background:#0066cc; color:white; border:none; border-radius:8px; font-weight:bold; font-size:16px; cursor:pointer;">閉じる</button>
    </div>
</div>


<div class="modal" id="modalTraceGame">
  <div class="modal-content trace-modal">
    <h2 data-lang="title_trace">なぞりゲーム</h2>

    <div class="trace-info">
      <div class="trace-row">
        <div class="trace-label" data-lang="trace_target">お題</div>
        <div class="trace-value"><span id="traceTargetName">--</span></div>
      </div>
      <div class="trace-row">
        <div class="trace-label" data-lang="trace_best">自己ベスト</div>
        <div class="trace-value"><span id="traceBestScore">--</span></div>
      </div>
      <div class="trace-row">
        <div class="trace-label" data-lang="trace_rule">ルール</div>
        <div class="trace-value" data-lang="trace_rule_text">赤いルートに近いほど高得点。塗りつぶし（描きすぎ）は減点。</div>
      </div>
    </div>

    <div class="trace-actions">
      <button class="btn-block trace-btn" id="btnTraceStart" data-lang="trace_start">スタート</button>
      <div class="trace-actions-row">
        <button class="btn-half" id="btnTraceReset" data-lang="trace_reset">リセット</button>
        <button class="btn-half" id="btnTraceSubmit" data-lang="trace_submit">採点</button>
      </div>
      <label class="trace-toggle">
        <input type="checkbox" id="chkTraceHint" checked />
        <span data-lang="trace_hint">お題を表示（ヒント）</span>
      </label>
      <label class="trace-toggle">
        <input type="checkbox" id="chkTracePanZoom" />
        <span data-lang="trace_panzoom">描画中も地図操作を許可</span>
      </label>
    </div>

    <div class="trace-result" id="traceResult" style="display:none;">
      <h3 data-lang="trace_result">結果</h3>
      <div class="trace-scoreline"><span data-lang="trace_score">スコア</span>: <b id="traceScore">--</b></div>
      <div class="trace-breakdown" id="traceBreakdown">--</div>
    </div>

    <button class="btn-block" style="background:#888;" onclick="closeModals();" data-lang="btn_close">閉じる</button>
    <button class="btn-block btn-danger"
  onclick="if(window.TraceGame) TraceGame.stop(); document.getElementById('modalTraceGame')?.classList.remove('open','minimized');">
  終了
</button>
  </div>
</div>


<div id="pocketModeOverlay">
  <div id="pocketModeText">画面を3秒長押しで解除</div>
  <div id="pocketModeProgress"></div>
</div>

<script src="./assets/js/config.js?v=20260118" defer></script>
<script src="./assets/js/worldmap.js" defer></script>
<script src="./assets/js/trace_game.js"  defer></script>
<script src="./assets/js/route_editor.js" defer></script>
</body>
</html>