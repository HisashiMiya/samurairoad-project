<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Online Shogi + Chat (CF Workers/DO)</title>
  <style>
    :root{--bg:#0b1020;--card:#111a33;--line:rgba(255,255,255,.12);--text:#e8eefc;--muted:#b9c6ea;--accent:#7aa2ff;}
    body{margin:0;background:linear-gradient(180deg,#070b18,var(--bg));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:14px}
    @media(min-width:980px){.wrap{grid-template-columns: 1fr 360px;align-items:start}}
    .card{background:rgba(17,26,51,.55);border:1px solid var(--line);border-radius:16px;padding:14px}
    h1{font-size:1.2rem;margin:0 0 8px}
    .muted{color:var(--muted);font-size:.92rem;line-height:1.6}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{min-height:44px;padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#0f1730;color:var(--text);cursor:pointer;font-weight:700}
    .btn.primary{background:#1c2a55;border-color:rgba(122,162,255,.45)}
    .btn.ghost{background:rgba(255,255,255,.04)}
    .btn[disabled]{opacity:.45;cursor:not-allowed}
    .input{min-height:44px;border-radius:12px;border:1px solid var(--line);background:#0f1730;color:var(--text);padding:10px 12px;width:100%}
    .status{padding:10px;border-radius:12px;background:rgba(0,0,0,.25);border:1px solid var(--line);font-size:.92rem}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.18);font-weight:800}
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(122,162,255,.7)}

    /* å°†æ£‹ç›¤ */
    #board{
      display:grid;
      grid-template-columns:repeat(9,1fr);
      grid-template-rows:repeat(9,1fr);
      aspect-ratio:1/1;
      width:min(92vw,640px);
      margin:0 auto;
      background:#f1d79a;
      border:6px solid #b58a45;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .cell{
      border:1px solid rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      position:relative;
      font-size:clamp(16px,2.4vw,26px);
      color:#102040;
    }
    .cell:hover{background:rgba(122,162,255,.08)}
    .cell.sel{
      outline:3px solid rgba(122,162,255,.9);
      outline-offset:-3px;
      background:rgba(122,162,255,.12);
    }
    .cell.rev{ color:#3a2a12; transform:rotate(180deg); }
    .piece.promoted{ color:#c81e1e; } /* âœ… æˆé§’ã‚’èµ¤æ–‡å­— */
    .coord{
      position:absolute;
      right:4px;
      bottom:3px;
      font-size:10px;
      color:rgba(0,0,0,.35);
      font-weight:600;
      transform:none;
      pointer-events:none;
    }
    .hint{margin-top:10px;color:var(--muted);font-size:.9rem;line-height:1.5}

    /* æŒã¡é§’ */
    .hands{display:grid;gap:10px;margin-top:10px}
    .hand{border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(0,0,0,.18)}
    .handTitle{display:flex;justify-content:space-between;align-items:center;font-weight:900;margin-bottom:8px}
    .handPieces{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid rgba(0,0,0,.25);border-radius:999px;padding:6px 10px;font-weight:900;cursor:pointer;background:#f1d79a;display:inline-flex;gap:6px;align-items:center;color:#102040}
    .chip.sel{outline:2px solid var(--accent)}
    .chip.disabled{opacity:.4;cursor:not-allowed}
    .chip .cnt{font-size:.85rem;color:var(--muted);font-weight:800}

    /* ãƒãƒ£ãƒƒãƒˆ */
    .chatLog{height:320px;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(0,0,0,.22)}
    .msg{margin:0 0 8px}
    .msg b{color:var(--accent)}
    .small{font-size:.85rem;color:var(--muted)}
    code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:6px}
  
    .badge.turnBig{
      font-size:1.05rem;
      padding:10px 14px;
      border-color:rgba(122,162,255,.65);
      box-shadow:0 6px 18px rgba(0,0,0,.25);
      background:rgba(122,162,255,.10);
    }
    .badge.turnBig .dot{
      width:12px;height:12px;
      box-shadow:0 0 0 4px rgba(122,162,255,.15);
    }

  
    .badge.turnBig.turnMine{
      border-color:rgba(80,220,150,.85);
      background:rgba(80,220,150,.12);
      box-shadow:0 8px 22px rgba(0,0,0,.28);
    }
    .badge.turnBig.turnMine .dot{
      background:rgba(80,220,150,.95);
      box-shadow:0 0 0 5px rgba(80,220,150,.18);
    }
    .badge.turnBig.turnOther{
      border-color:rgba(255,190,90,.75);
      background:rgba(255,190,90,.10);
    }
    .badge.turnBig.turnOther .dot{
      background:rgba(255,190,90,.9);
      box-shadow:0 0 0 5px rgba(255,190,90,.16);
    }

  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <h1>æ¥µã¿å°†æ£‹</h1>
      <p class="muted">
        URLã® <code>#room=xxxx</code> ã‚’å…±æœ‰ã™ã‚‹ã¨åŒã˜éƒ¨å±‹ã«å…¥ã‚Œã¾ã™ã€‚<br>
        MVPï¼šåˆæ³•æ‰‹ãƒ»ç‹æ‰‹åˆ¤å®šãƒ»æ‰“ã¡æ­©è©°ã‚ç­‰ã¯æœªå¯¾å¿œï¼ˆãŸã ã—ã€ŒäºŒæ­©ã€ã€Œè¡Œãæ‰€ã®ãªã„é§’ã®æ‰“ã¡ã€ã¯æœ€ä½é™ã‚¬ãƒ¼ãƒ‰ï¼‰ã€‚<br>
        <b>æˆã‚Š</b>ã¯å®Ÿè£…æ¸ˆã¿ï¼ˆæˆã‚Œã‚‹å ´åˆã¯ç¢ºèªã€å¼·åˆ¶æˆã‚Šã‚‚å¯¾å¿œï¼‰ã€‚
      </p>

      <div class="row" style="margin:10px 0">
        <input id="name" class="input" style="max-width:220px" placeholder="åå‰" />
        <button class="btn primary" id="btnConnect">æ¥ç¶š</button>
        <button class="btn" id="btnCopyUrl">éƒ¨å±‹URLã‚³ãƒ”ãƒ¼</button>
        <button class="btn" id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
        <button class="btn ghost" id="btnSound">ğŸ”Š éŸ³: ON</button>
      </div>
<div class="status" id="status">æœªæ¥ç¶š</div>

      <div class="row" style="margin:10px 0 12px">
        <span class="badge turnBig" id="turnBadge"><span class="dot"></span><span id="turnText">æ‰‹ç•ª: -</span></span>
      </div>


<div class="hand">
            <div class="handTitle"><span>å¾Œæ‰‹ã®æŒã¡é§’</span><span class="small" id="handHintG"></span></div>
            <div class="handPieces" id="handG"></div>
          </div>

      <div style="margin-top:12px">
        <div id="board" aria-label="shogi-board"></div>

        <div class="hands">
          
          <div class="hand">
            <div class="handTitle"><span>å…ˆæ‰‹ã®æŒã¡é§’</span><span class="small" id="handHintS"></span></div>
            <div class="handPieces" id="handS"></div>
          </div>
        </div>

        <div class="hint">
          ãƒ»æŒã¡é§’ã¯ <b>è‡ªåˆ†ã®æ‰‹ç•ª</b>ã®ã¨ãã ã‘é¸ã¹ã¾ã™ï¼ˆé¸æŠâ†’ç›¤ã®ç©ºãƒã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã§æ‰“ã¤ï¼‰ã€‚<br>
          ãƒ»ç›¤ã®é§’ã‚’é¸æŠâ†’ç§»å‹•å…ˆã‚¯ãƒªãƒƒã‚¯ã§å‹•ã‹ã—ã¾ã™ã€‚<br>
          ãƒ»ç‹ãŒå–ã‚‰ã‚ŒãŸã‚‰å‹æ•—è¡¨ç¤ºâ†’ã€Œç¶šã‘ã¾ã™ã‹ï¼Ÿã€ã‚’å‡ºã—ã¾ã™ï¼ˆåŒæ–¹Yesã§ãƒªã‚»ãƒƒãƒˆï¼‰ã€‚<br>ãƒ»é€šä¿¡åŸºç›¤ã¯å¤‰æ›´ãªã—ï¼ˆWorker/DOã¯ä¸­ç¶™ãƒ»åŒæœŸãƒ»ä¿å­˜ã®ã¿ï¼‰ã€‚
        </div>
      

      <div class="card" style="margin-top:14px;background:rgba(0,0,0,.18)">
        <h1 style="font-size:1.05rem;margin:0 0 8px">é–‹ç™ºè€…ãƒ¡ãƒ¢</h1>
        <div class="muted" style="font-size:.92rem;line-height:1.65">
          <div>MVPï¼šåˆæ³•æ‰‹ãƒ»ç‹æ‰‹åˆ¤å®šãƒ»æ‰“ã¡æ­©è©°ã‚ç­‰ã¯æœªå¯¾å¿œï¼ˆãŸã ã—ã€ŒäºŒæ­©ã€ã€Œè¡Œãæ‰€ã®ãªã„é§’ã®æ‰“ã¡ã€ã¯æœ€ä½é™ã‚¬ãƒ¼ãƒ‰ï¼‰ã€‚</div>
          <div>æˆã‚Šã¯å®Ÿè£…æ¸ˆã¿ï¼ˆæˆã‚Œã‚‹å ´åˆã¯ç¢ºèªã€å¼·åˆ¶æˆã‚Šã‚‚å¯¾å¿œï¼‰ã€‚</div>
          <div>ãƒ»æŒã¡é§’ã¯ <b>è‡ªåˆ†ã®æ‰‹ç•ª</b>ã®ã¨ãã ã‘é¸ã¹ã¾ã™ï¼ˆé¸æŠâ†’ç›¤ã®ç©ºãƒã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã§æ‰“ã¤ï¼‰ã€‚</div>
          <div>ãƒ»ç›¤ã®é§’ã‚’é¸æŠâ†’ç§»å‹•å…ˆã‚¯ãƒªãƒƒã‚¯ã§å‹•ã‹ã—ã¾ã™ã€‚</div>
          <div>ãƒ»ç‹ãŒå–ã‚‰ã‚ŒãŸã‚‰å‹æ•—è¡¨ç¤ºï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºï¼‰ã€‚</div>
          <div>ãƒ»é€šä¿¡åŸºç›¤ã¯å¤‰æ›´ãªã—ï¼ˆWorker/DOã¯ä¸­ç¶™ãƒ»åŒæœŸãƒ»ä¿å­˜ã®ã¿ï¼‰ã€‚</div>
        </div>
      </div>

      <div class="small" style="margin-top:14px;text-align:right;opacity:.85">
        Â© hisa.miya
      </div>
</div>
    </section>

    <aside class="card">
      <h1>ãƒãƒ£ãƒƒãƒˆ</h1>
      <div class="chatLog" id="chatLog"></div>
      <div class="row" style="margin-top:10px">
        <input id="chatInput" class="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸â€¦" />
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnSend">é€ä¿¡</button>
      </div>
      <p class="small">â€»è¦³æˆ¦è€…ã‚‚ãƒãƒ£ãƒƒãƒˆå¯èƒ½ã€‚å¯¾å±€ã¯å…ˆç€2äººãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ãªã‚Šã¾ã™ï¼ˆMVPã®ãŸã‚å¼·åˆ¶ã¯æœªå®Ÿè£…ï¼‰ã€‚</p>
    </aside>
  </div>

<script>
(() => {
  // Workerï¼ˆâ€»ãƒ‘ã‚¹ã¯ä¾é ¼ãŒãªã„é™ã‚Šå¤‰æ›´ã—ãªã„ï¼‰
  const WORKER_WS = "wss://samurairoad-ws.korokorokororintyo.workers.dev";

  // DOM
  const boardEl  = document.getElementById("board");
  const statusEl = document.getElementById("status");
  const nameEl   = document.getElementById("name");
  const btnConnect = document.getElementById("btnConnect");
  const btnCopyUrl = document.getElementById("btnCopyUrl");
  const btnReset = document.getElementById("btnReset");
  const chatLog = document.getElementById("chatLog");
  const chatInput = document.getElementById("chatInput");
  const btnSend = document.getElementById("btnSend");
  const btnSound = document.getElementById("btnSound");
  const turnText = document.getElementById("turnText");
  const handS = document.getElementById("handS");
  const handG = document.getElementById("handG");
  const handHintS = document.getElementById("handHintS");
  const handHintG = document.getElementById("handHintG");

  // Name cache
  try{
    const cached = localStorage.getItem("shogi_name");
    if (cached && !nameEl.value) nameEl.value = cached;
  }catch{}


  // é§’è¡¨è¨˜ï¼ˆå¤§æ–‡å­—=å…ˆæ‰‹ / å°æ–‡å­—=å¾Œæ‰‹ / "+X"=æˆã‚Šï¼‰
  const PIECE = {
    L:"é¦™",N:"æ¡‚",S:"éŠ€",G:"é‡‘",K:"ç‹",R:"é£›",B:"è§’",P:"æ­©",
    l:"é¦™",n:"æ¡‚",s:"éŠ€",g:"é‡‘",k:"ç‹",r:"é£›",b:"è§’",p:"æ­©",
    "+P":"ã¨","+p":"ã¨",
    "+L":"æˆé¦™","+l":"æˆé¦™",
    "+N":"æˆæ¡‚","+n":"æˆæ¡‚",
    "+S":"æˆéŠ€","+s":"æˆéŠ€",
    "+B":"é¦¬","+b":"é¦¬",
    "+R":"é¾","+r":"é¾"
  };

  const HAND_ORDER = ["R","B","G","S","N","L","P"];
  const HAND_LABEL = { R:"é£›",B:"è§’",G:"é‡‘",S:"éŠ€",N:"æ¡‚",L:"é¦™",P:"æ­©" };

  function basePiece(p){ return (typeof p === "string" && p.startsWith("+")) ? p.slice(1) : p; }
  function isPromoted(p){ return (typeof p === "string" && p.startsWith("+")); }
  function isSente(p){ const b = basePiece(p); return b && b === b.toUpperCase(); }
  function isGote(p){ const b = basePiece(p); return b && b === b.toLowerCase(); }
  function toSide(piece){ return isSente(piece) ? "S" : "G"; }

  function normalizeHands(g){
    if (!g.hands) g.hands = { S: {}, G: {} };
    if (!g.hands.S) g.hands.S = {};
    if (!g.hands.G) g.hands.G = {};
    return g;
  }

  function initialGame(){
    return normalizeHands({
      turn:"S",
      board:[
        ["l","n","s","g","k","g","s","n","l"],
        [null,"r",null,null,null,null,null,"b",null],
        ["p","p","p","p","p","p","p","p","p"],
        [null,null,null,null,null,null,null,null,null],
        [null,null,null,null,null,null,null,null,null],
        [null,null,null,null,null,null,null,null,null],
        ["P","P","P","P","P","P","P","P","P"],
        [null,"B",null,null,null,null,null,"R",null],
        ["L","N","S","G","K","G","S","N","L"],
      ],
      hands: { S: {}, G: {} },
          });
  }

  let ws = null;
  let game = initialGame();
  let selected = null;         // {r,c}
  let selectedDrop = null;     // {side,type}
  let myName = "guest";
  let mySide = null; // "S" or "G" is learned from your first move/drop


  function setStatus(t){ statusEl.textContent = t; }
    function setTurnUI(){
    const t = game.turn === "S" ? "å…ˆæ‰‹" : "å¾Œæ‰‹";
    turnText.textContent = `æ‰‹ç•ª: ${t}`;
    handHintS.textContent = (game.turn === "S") ? "ï¼ˆæ‰‹ç•ªãªã‚‰é¸æŠã§ãã¾ã™ï¼‰" : "";
    handHintG.textContent = (game.turn === "G") ? "ï¼ˆæ‰‹ç•ªãªã‚‰é¸æŠã§ãã¾ã™ï¼‰" : "";
    const badge = document.getElementById("turnBadge");
    if (badge){
      badge.classList.remove("turnMine","turnOther");
      if (mySide){
        badge.classList.add((game.turn === mySide) ? "turnMine" : "turnOther");
      }
    }
  }
    }
    const t = game.turn === "S" ? "å…ˆæ‰‹" : "å¾Œæ‰‹";
    if (meta.gameOver && meta.winner){
      turnText.textContent = `çµ‚å±€: ${sideLabel(meta.winner)}ã®å‹ã¡`;
    } else {
      turnText.textContent = `æ‰‹ç•ª: ${t}`;
    }
    handHintS.textContent = (game.turn === "S") ? "ï¼ˆæ‰‹ç•ªãªã‚‰é¸æŠã§ãã¾ã™ï¼‰" : "";
    handHintG.textContent = (game.turn === "G") ? "ï¼ˆæ‰‹ç•ªãªã‚‰é¸æŠã§ãã¾ã™ï¼‰" : "";
  }
  function sideLabel(side){ return side === "S" ? "å…ˆæ‰‹" : "å¾Œæ‰‹"; }

  function isKingPiece(p){
    const b = basePiece(p);
    return b === "K" || b === "k";
  }

  function showWinPopup(winnerSide){
    // è¦æœ›ï¼šç‹ãŒå–ã‚‰ã‚ŒãŸå¾Œã¯ã€ŒXXXã®å‹ã¡ã€ã ã‘ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
    window.alert(`${sideLabel(winnerSide)}ã®å‹ã¡`);
  }


  // ---- éŸ³ï¼ˆWebAudioï¼‰ ----
  let audioEnabled = true;
  let audioCtx = null;
  function ensureAudioUnlocked(){
    if (!audioEnabled) return;
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
  }
  function beep(freq=440, dur=0.06, type="sine", gain=0.06){
    if (!audioEnabled) return;
    ensureAudioUnlocked();
    if (!audioCtx) return;
    const t0 = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, t0);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(t0); o.stop(t0+dur+0.02);
  }
  const sfx = {
    move(){ beep(520, 0.05, "square", 0.05); },
    capture(){ beep(220, 0.07, "triangle", 0.06); beep(180, 0.05, "triangle", 0.05); },
    promote(){ beep(740, 0.05, "sine", 0.05); beep(980, 0.06, "sine", 0.05); },
    drop(){ beep(430, 0.06, "square", 0.05); },
    chat(){ beep(660, 0.04, "sine", 0.04); }
  };

  btnSound.addEventListener("click", () => {
    audioEnabled = !audioEnabled;
    btnSound.textContent = audioEnabled ? "ğŸ”Š éŸ³: ON" : "ğŸ”‡ éŸ³: OFF";
    if (audioEnabled) ensureAudioUnlocked();
  });

  function appendChat(user, text){
    const div = document.createElement("div");
    div.className = "msg";
    div.innerHTML = `<b>${escapeHtml(user)}</b> ${escapeHtml(text)}`;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }
  function appendSystem(text){
    const div = document.createElement("div");
    div.className = "msg";
    div.innerHTML = `<span class="small">${escapeHtml(text)}</span>`;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }
  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function drawHands(){
    const s = game.hands.S || {};
    const g = game.hands.G || {};
    handS.innerHTML = "";
    handG.innerHTML = "";

    const render = (side, el) => {
      const h = side === "S" ? s : g;
      let any = false;

      for (const t of HAND_ORDER){
        const n = Number(h[t] || 0);
        if (n <= 0) continue;
        any = true;

        const chip = document.createElement("button");
        chip.className = "chip";
        chip.type = "button";
        chip.innerHTML = `<span>${HAND_LABEL[t]}</span><span class="cnt">Ã—${n}</span>`;

        const isMyTurn = (game.turn === side);
        if (!isMyTurn){
          chip.classList.add("disabled");
          chip.disabled = true;
        } else {
          chip.addEventListener("click", () => {
            ensureAudioUnlocked();
            selected = null;
            if (selectedDrop && selectedDrop.side === side && selectedDrop.type === t) selectedDrop = null;
            else selectedDrop = { side, type: t };
            draw();
          });
        }

        if (selectedDrop && selectedDrop.side === side && selectedDrop.type === t) chip.classList.add("sel");
        el.appendChild(chip);
      }

      if (!any){
        const span = document.createElement("span");
        span.className = "small";
        span.textContent = "ï¼ˆãªã—ï¼‰";
        el.appendChild(span);
      }
    };

    render("S", handS);
    render("G", handG);
  }

  function draw(){
    normalizeHands(game);
    setTurnUI();
    drawHands();

    boardEl.innerHTML = "";
    for (let r=0; r<9; r++){
      for (let c=0; c<9; c++){
        const p = game.board[r][c];
        const d = document.createElement("div");
        d.className =
          "cell" +
          (p && isGote(p) ? " rev" : "") +
          (selected && selected.r===r && selected.c===c ? " sel" : "");
        d.dataset.r = r;
        d.dataset.c = c;

        const pieceSpan = document.createElement("span");
        pieceSpan.className = "piece" + (p && isPromoted(p) ? " promoted" : "");
        pieceSpan.textContent = p ? (PIECE[p] || PIECE[basePiece(p)] || "") : "";
        d.appendChild(pieceSpan);

        const coord = document.createElement("span");
        coord.className = "coord";
        coord.textContent = `${9 - c}${r + 1}`;
        d.appendChild(coord);

        boardEl.appendChild(d);
      }
    }
  }

  // ---- æˆã‚Š ----
  function inPromoZone(turn, r){
    if (turn === "S") return r <= 2;
    return r >= 6;
  }
  function canPromote(pieceBase){
    return !["K","G","k","g"].includes(pieceBase);
  }
  function isPromotableMove(turn, piece, fromR, toR){
    if (!piece) return false;
    if (isPromoted(piece)) return false;
    const b = basePiece(piece);
    if (!canPromote(b)) return false;
    return inPromoZone(turn, fromR) || inPromoZone(turn, toR);
  }
  function isForcedPromotion(turn, piece, toR){
    const b = basePiece(piece).toUpperCase();
    if (b === "P" || b === "L"){
      return (turn === "S") ? (toR === 0) : (toR === 8);
    }
    if (b === "N"){
      return (turn === "S") ? (toR <= 1) : (toR >= 7);
    }
    return false;
  }
  function decidePromotion(turn, piece, fromR, toR){
    if (!isPromotableMove(turn, piece, fromR, toR)) return false;
    if (isForcedPromotion(turn, piece, toR)) return true;
    return window.confirm("æˆã‚Šã¾ã™ã‹ï¼Ÿ");
  }
  function applyPromotion(piece){
    if (!piece || isPromoted(piece)) return piece;
    return "+" + piece;
  }

  // ---- æŒã¡é§’ ----
  function addToHand(side, capturedPiece){
    const b = basePiece(capturedPiece);
    const t = b.toUpperCase();
    game.hands[side][t] = Number(game.hands[side][t] || 0) + 1;
  }

  function canDropHere(side, type, r, c){
    if (game.board[r][c] != null) return false;

    // è¡Œãæ‰€ã®ãªã„é§’ï¼ˆæœ€ä½é™ï¼‰
    if (type === "P" || type === "L"){
      if (side === "S" && r === 0) return false;
      if (side === "G" && r === 8) return false;
    }
    if (type === "N"){
      if (side === "S" && r <= 1) return false;
      if (side === "G" && r >= 7) return false;
    }

    // äºŒæ­©ï¼ˆæœ€ä½é™ï¼‰
    if (type === "P"){
      for (let rr=0; rr<9; rr++){
        const p = game.board[rr][c];
        if (!p) continue;
        if (side === "S" && p === "P") return false;
        if (side === "G" && p === "p") return false;
      }
    }
    return true;
  }

  function dropPiece(side, type, r, c){
    if (!canDropHere(side, type, r, c)){
      appendSystem("ãã®å ´æ‰€ã«ã¯æ‰“ã¦ã¾ã›ã‚“ï¼ˆç©ºã/äºŒæ­©/è¡Œãæ‰€ãªã—ï¼‰");
      return false;
    }
    const h = game.hands[side];
    if (Number(h[type] || 0) <= 0) return false;

    const piece = (side === "S") ? type : type.toLowerCase();
    game.board[r][c] = piece;
    h[type] = Number(h[type]) - 1;
    if (h[type] <= 0) delete h[type];
    return true;
  }

  // ---- WS ----
  function currentRoom(){
    return (location.hash.match(/room=([a-zA-Z0-9_-]+)/)?.[1]) || "lobby";
  }

  function connect(){
    ensureAudioUnlocked();
    const room = currentRoom();
    myName = (nameEl.value || "guest").trim().slice(0, 24) || "guest";
    try{ localStorage.setItem("shogi_name", myName); }catch{}


    if (ws) { try{ ws.close(); }catch{} ws=null; }
    ws = new WebSocket(`${WORKER_WS}/?room=${encodeURIComponent(room)}`);

    ws.onopen = () => {
      setStatus(`æ¥ç¶šä¸­â€¦ room=${room}`);
      appendSystem(`æ¥ç¶šã—ã¾ã—ãŸï¼ˆroom=${room}ï¼‰`);
      ws.send(JSON.stringify({ type:"join", user:myName, room, payload:"" }));
      ws.send(JSON.stringify({ type:"state", room, payload: game }));
    };

    ws.onclose = () => { setStatus("åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ"); appendSystem("åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ"); };
    ws.onerror = () => { setStatus("æ¥ç¶šã‚¨ãƒ©ãƒ¼ï¼ˆURL/WorkerçŠ¶æ…‹ã‚’ç¢ºèªï¼‰"); appendSystem("æ¥ç¶šã‚¨ãƒ©ãƒ¼"); };

    ws.onmessage = (ev) => {
      let m; try{ m = JSON.parse(ev.data); }catch{ return; }

      if (m.type === "state" && m.payload && m.payload.board){
        game = normalizeHands(m.payload);
        selected = null;
        selectedDrop = null;
        draw();
        return;
      }

      if ((m.type === "chat" || m.type === "msg") && (m.payload || m.text)){
        const text = (typeof m.payload === "string") ? m.payload : (m.text ?? "");
        const user = m.user || "anon";
        appendChat(user, text);
        sfx.chat();
        return;
      }
      if (m.type === "join"){ appendSystem(`${m.user || "anon"} ãŒå…¥å®¤`); return; }
      if (m.type === "system"){ appendSystem(String(m.payload ?? "")); return; }
    };
  }

  function sendChat(){
    ensureAudioUnlocked();
    if (!ws || ws.readyState !== 1) return;
    const text = (chatInput.value || "").trim();
    if (!text) return;
    const room = currentRoom();
    ws.send(JSON.stringify({ type:"msg", user:myName, room, payload:text }));
    chatInput.value = "";
    sfx.chat();
  }

  function sendState(){
    if (!ws || ws.readyState !== 1) return;
    ws.send(JSON.stringify({ type:"state", room: currentRoom(), payload: game }));
  }

  boardEl.addEventListener("click", (e) => {
    ensureAudioUnlocked();
    const cell = e.target.closest(".cell");
    if (!cell) return;
    if (!ws || ws.readyState !== 1) return;

    const r = Number(cell.dataset.r);
    const c = Number(cell.dataset.c);

    // æ‰“ã¡å„ªå…ˆ
    if (selectedDrop){
      const side = selectedDrop.side;
      const type = selectedDrop.type;

      if (game.turn !== side){ appendSystem("æ‰‹ç•ªã§ã¯ã‚ã‚Šã¾ã›ã‚“"); return; }

      if (!dropPiece(side, type, r, c)) return;

      selectedDrop = null;
      selected = null;
      if (!mySide) mySide = game.turn;
      game.turn = (game.turn === "S") ? "G" : "S";
      draw();
      sendState();
      sfx.drop();
      return;
    }

    // é€šå¸¸ã®é¸æŠ/ç§»å‹•
    if (!selected){
      const p = game.board[r][c];
      if (!p) return;

      const isS = (game.turn === "S");
      if (isS && !isSente(p)) return;
      if (!isS && !isGote(p)) return;

      selected = {r,c};
      draw();
      return;
    }

    const from = selected;
    let piece = game.board[from.r][from.c];
    if (!piece){ selected=null; draw(); return; }

    const dest = game.board[r][c];
    if (dest && toSide(dest) === game.turn){ selected=null; draw(); return; }

    let didCapture = false;
    if (dest){
      if (isKingPiece(dest)){
        // Capture king -> game over
        // Winner is the side who captured
        showWinPopup(game.turn);
        // Do not add king to hand
      } else {
        addToHand(game.turn, dest);
      }
      didCapture = true;
    }

    game.board[from.r][from.c] = null;

    const promote = decidePromotion(game.turn, piece, from.r, r);
    if (promote) piece = applyPromotion(piece);

    game.board[r][c] = piece;

    selected = null;
    if (!mySide) mySide = game.turn;
      game.turn = (game.turn === "S") ? "G" : "S";
    draw();
    sendState();

    if (didCapture) sfx.capture(); else sfx.move();
    if (promote) sfx.promote();
  });

  // UI
  btnConnect.addEventListener("click", connect);
  btnCopyUrl.addEventListener("click", async () => {
    const room = currentRoom();
    const url = `${location.origin}${location.pathname}#room=${room}`;
    try{ await navigator.clipboard.writeText(url); appendSystem("éƒ¨å±‹URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }
    catch{ appendSystem("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ¨©é™ï¼‰"); }
  });
  btnReset.addEventListener("click", () => {
    ensureAudioUnlocked();
    game = initialGame();
    selected = null;
    selectedDrop = null;
    draw();
    sendState();
    sfx.move();
  });

  btnSend.addEventListener("click", sendChat);
  chatInput.addEventListener("keydown", (e) => { if (e.key === "Enter") sendChat(); });

  draw();
})();
</script>
</body>
</html>
